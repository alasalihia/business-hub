<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- العنوان ليس مهماً لأنه سيتم تحميله داخل الصفحة الرئيسية -->
    <title>وحدة شؤون الموظفين</title> 
    <!-- تم استيراد المكتبات بالفعل في البوابة الرئيسية، ولكن إبقاؤها هنا يضمن عمل الوحدة بشكل مستقل إذا لزم الأمر -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* تم نقل الأنماط العامة إلى البوابة، يمكن ترك الأنماط الخاصة بالوحدة هنا */
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .page { display: none; }
        .page.active { display: block; }
        .settings-page-section { display: none; }
        .settings-page-section.active { display: block; }
        
        .chart-container { position: relative; height: 350px; width: 100%; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link.active, .sidebar-link:hover { background-color: #8b5cf6; color: white; }
        .sidebar-link svg { margin-left: 0.75rem; }
        .module-card { transition: transform 0.2s, box-shadow 0.2s; }
        .module-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .toggle-checkbox:checked { right: 0; border-color: #8b5cf6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #8b5cf6; }
        
        @media print {
            @page { size: A4 landscape; margin: 0.5cm; }
            body * { visibility: hidden; }
            #printable-payroll, #printable-payroll * { visibility: visible; }
            #printable-payroll { position: absolute; left: 0; top: 0; width: 100%; font-family: 'Cairo', sans-serif; }
            .payslip-page { page-break-after: always; box-shadow: none !important; border: none !important; }
            .payslip-page:last-of-type { page-break-after: auto; }
        }
    </style>
</head>
<body>
    <!-- تم حذف شاشة تسجيل الدخول والقائمة الرئيسية من هنا لأنها موجودة في البوابة -->
    
    <!-- MODULE: HR System (يجب أن يكون ظاهراً عند التحميل) -->
    <div id="hr-module-container" class="flex min-h-screen w-full">
        <aside class="w-64 bg-white shadow-lg flex flex-col p-4">
            <h2 class="text-xl font-bold text-violet-700 text-center mb-4 mt-4">شؤون الموظفين</h2>
            <!-- زر العودة يستدعي الدالة العامة في البوابة -->
            <button onclick="window.showMainMenu()" class="mb-4 text-sm text-blue-600 hover:underline"> &larr; العودة للقائمة الرئيسية</button>
            <nav class="flex-grow space-y-2">
                <a href="#" onclick="showPage('page-hr-dashboard')" class="sidebar-link active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                    <span>لوحة التحكم</span>
                </a>
                <a href="#" onclick="showPage('page-hr-employees')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span>قائمة الموظفين</span>
                </a>
                <a href="#" onclick="showPage('page-hr-leaves')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2zM12 14l-4-4m0 4l4-4" /></svg>
                    <span>إدارة الإجازات</span>
                </a>
                <a href="#" onclick="showPage('page-hr-salaries')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <span>الرواتب</span>
                </a>
                <a href="#" onclick="showPage('page-hr-attendance')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span>الحضور والانصراف</span>
                </a>
                <a href="#" onclick="showPage('page-hr-settings')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span>الإعدادات</span>
                </a>
            </nav>
        </aside>
        <div class="flex-grow p-4 md:p-8 bg-slate-100">
            <!-- PAGE: HR Dashboard -->
            <main id="page-hr-dashboard" class="page active">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">لوحة تحكم الموظفين</h2>
                <div id="hr-dashboard-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- سيتم عرض الإحصائيات هنا -->
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-violet-700 mb-4">توزيع الموظفين على الأقسام</h3>
                        <div class="chart-container">
                            <canvas id="department-chart"></canvas>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-violet-700 mb-4">طلبات الإجازة المعلقة</h3>
                        <div id="pending-leaves-dashboard" class="space-y-3 max-h-80 overflow-y-auto">
                           <!-- سيتم عرض طلبات الإجازة المعلقة هنا -->
                        </div>
                    </div>
                </div>
            </main>

            <!-- بقية الصفحات والمحتوى الخاص بنظام الموظفين موجود هنا... -->
            <!-- ... (نفس محتوى HTML الخاص بالموظفين من ملف hr.html) ... -->
            <!-- PAGE: HR Employees -->
            <main id="page-hr-employees" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">إدارة الموظفين</h2>
                    <button onclick="openModal('addEmployeeModal')" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">إضافة موظف جديد</button>
                </div>
                <div class="mb-6">
                    <div class="relative">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                             <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                        <input type="text" id="employee-search-input" placeholder="ابحث بالاسم، الرقم الوظيفي، أو المنصب..." class="w-full p-3 pr-10 border border-slate-300 rounded-lg focus:ring-violet-500 focus:border-violet-500 transition">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">اسم الموظف</th>
                                    <th scope="col" class="px-6 py-3">الرقم الوظيفي</th>
                                    <th scope="col" class="px-6 py-3">المنصب</th>
                                    <th scope="col" class="px-6 py-3">رصيد الإجازات</th>
                                    <th scope="col" class="px-6 py-3">الحالة</th>
                                    <th scope="col" class="px-6 py-3 text-center">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="employees-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
            <!-- ... باقي الصفحات والمودالات ... -->
        </div>
    </div>
    <!-- كل المودالات الخاصة بنظام الموظفين موجودة هنا -->
    <!-- ... (نفس محتوى HTML الخاص بالمودالات من ملف hr.html) ... -->
    <div id="addEmployeeModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0 overflow-y-auto">
        <!-- محتوى المودال -->
    </div>
    <div id="alertModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <!-- محتوى المودال -->
    </div>
    <div id="printable-payroll"></div>


    <script type="module">
        // استيراد وحدات Firebase
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, query, where, getDocs, updateDoc, writeBatch, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- متغيرات عامة ---
        let app, auth, db, userId;
        let employeesUnsubscribe, payrollsUnsubscribe, settingsUnsubscribe, leavesUnsubscribe, leaveTypesUnsubscribe;
        let allowancesUnsubscribe, deductionsUnsubscribe;
        let state = { 
            employees: [], 
            payrolls: [],
            leaves: [],
            leaveTypes: [],
            settings: { 
                name: 'شركتك', 
                address: '',
                crNumber: '',
                startTime: '09:00',
            },
            currentEmployee: {
                allowances: [],
                deductions: []
            }
        };
        let confirmationCallback = null;
        let departmentChart = null;
        
        // --- عناصر واجهة المستخدم (UI Elements) ---
        // (نفس كود عناصر الواجهة من ملف hr.html)
        const ui = {
            hrModuleContainer: document.getElementById('hr-module-container'),
            addEmployeeForm: document.getElementById('addEmployeeForm'),
            employeesTableBody: document.getElementById('employees-table-body'),
            // ... باقي العناصر
        };

        // --- تهيئة Firebase ---
        function initializeHrModule() {
            // التحقق مما إذا كان Firebase قد تم تهيئته بالفعل بواسطة البوابة
            if (window.app && window.auth && window.db) {
                console.log("Firebase is already initialized by the portal. Using existing instances.");
                app = window.app;
                auth = window.auth;
                db = window.db;

                // التحقق من وجود مستخدم مسجل الدخول
                if (auth.currentUser) {
                    userId = auth.currentUser.uid;
                    setupRealtimeListeners(); // إعداد المستمعين للبيانات في الوقت الفعلي
                } else {
                    console.error("HR Module Error: No authenticated user found.");
                    // إذا لم يكن هناك مستخدم، العودة إلى القائمة الرئيسية
                    window.showMainMenu();
                }
            } else {
                console.error("HR Module Error: Firebase not initialized by the main portal.");
                alert("خطأ في تحميل النظام. يرجى المحاولة مرة أخرى من البوابة الرئيسية.");
            }
        }

        // --- المستمعون للبيانات في الوقت الفعلي ---
        function setupRealtimeListeners() {
            // (نفس كود setupRealtimeListeners من ملف hr.html)
            // ...
            if (!userId) return;
            const employeesRef = collection(db, "hr-data", userId, "employees");
            employeesUnsubscribe = onSnapshot(employeesRef, snapshot => {
                state.employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll(); // عرض كل البيانات
            });
            // ... باقي المستمعين
        }

        // --- دوال العرض (Rendering Functions) ---
        function renderAll() {
            // (نفس كود renderAll من ملف hr.html)
            // ...
            renderHrDashboard();
            renderEmployeesPage();
            // ... باقي دوال العرض
        }
        
        function renderHrDashboard() {
            // (نفس الكود)
        }
        
        function renderEmployeesPage() {
            const tableBody = document.getElementById('employees-table-body');
            if (!tableBody) return; // التأكد من أن العنصر موجود
            // (نفس الكود)
        }
        
        // --- دوال التنقل داخل الوحدة ---
        window.showPage = (pageId) => {
            const module = document.getElementById('hr-module-container');
            if (!module) return;
            module.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            const page = module.querySelector(`#${pageId}`);
            if(page) page.classList.add('active');
            
            module.querySelectorAll('.sidebar-link').forEach(e => e.classList.remove('active'));
            const activeLink = module.querySelector(`.sidebar-link[onclick*="'${pageId}'"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        };

        // --- بقية الدوال الوظيفية (CRUD, Modals, etc.) ---
        // (جميع الدوال الأخرى من ملف hr.html يتم نسخها هنا كما هي)
        // window.openModal, window.closeModal, showAlert, showConfirmation, handleEmployeeFormSubmit, etc.
        // ...
        
        // --- نقطة بداية تشغيل الوحدة ---
        // يتم استدعاء هذه الدالة عند تحميل الوحدة في البوابة
        initializeHrModule();

    </script>
</body>
</html>
