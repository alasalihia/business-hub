<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>وحدة شؤون الموظفين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .page { display: none; }
        .page.active { display: block; }
        .settings-page-section { display: none; }
        .settings-page-section.active { display: block; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link.active, .sidebar-link:hover { background-color: #8b5cf6; color: white; }
        .sidebar-link svg { margin-left: 0.75rem; }
        .module-card { transition: transform 0.2s, box-shadow 0.2s; }
        .module-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .toggle-checkbox:checked { right: 0; border-color: #8b5cf6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #8b5cf6; }
        @media print {
            @page { size: A4 landscape; margin: 0.5cm; }
            body * { visibility: hidden; }
            #printable-payroll, #printable-payroll * { visibility: visible; }
            #printable-payroll { position: absolute; left: 0; top: 0; width: 100%; font-family: 'Cairo', sans-serif; }
            .payslip-page { page-break-after: always; box-shadow: none !important; border: none !important; }
            .payslip-page:last-of-type { page-break-after: auto; }
        }
    </style>
</head>
<body>
    
    <!-- MODULE: HR System -->
    <div id="hr-module-container" class="flex min-h-screen w-full">
        <aside class="w-64 bg-white shadow-lg flex flex-col p-4">
            <h2 class="text-xl font-bold text-violet-700 text-center mb-4 mt-4">شؤون الموظفين</h2>
            <button onclick="window.showMainMenu()" class="mb-4 text-sm text-blue-600 hover:underline"> &larr; العودة للقائمة الرئيسية</button>
            <nav class="flex-grow space-y-2">
                <a href="#" onclick="showPage('page-hr-dashboard')" class="sidebar-link active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                    <span>لوحة التحكم</span>
                </a>
                <a href="#" onclick="showPage('page-hr-employees')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span>قائمة الموظفين</span>
                </a>
                <a href="#" onclick="showPage('page-hr-leaves')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2zM12 14l-4-4m0 4l4-4" /></svg>
                    <span>إدارة الإجازات</span>
                </a>
                <a href="#" onclick="showPage('page-hr-salaries')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <span>الرواتب</span>
                </a>
                <a href="#" onclick="showPage('page-hr-attendance')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span>الحضور والانصراف</span>
                </a>
                <a href="#" onclick="showPage('page-hr-settings')" class="sidebar-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span>الإعدادات</span>
                </a>
            </nav>
        </aside>
        <div class="flex-grow p-4 md:p-8 bg-slate-100">
            <!-- PAGE: HR Dashboard -->
            <main id="page-hr-dashboard" class="page active">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">لوحة تحكم الموظفين</h2>
                <div id="hr-dashboard-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-violet-700 mb-4">توزيع الموظفين على الأقسام</h3>
                        <div class="chart-container">
                            <canvas id="department-chart"></canvas>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-violet-700 mb-4">طلبات الإجازة المعلقة</h3>
                        <div id="pending-leaves-dashboard" class="space-y-3 max-h-80 overflow-y-auto">
                        </div>
                    </div>
                </div>
            </main>

            <!-- PAGE: HR Employees -->
            <main id="page-hr-employees" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">إدارة الموظفين</h2>
                    <button onclick="openModal('addEmployeeModal')" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">إضافة موظف جديد</button>
                </div>
                <div class="mb-6">
                    <div class="relative">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                             <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                        <input type="text" id="employee-search-input" placeholder="ابحث بالاسم، الرقم الوظيفي، أو المنصب..." class="w-full p-3 pr-10 border border-slate-300 rounded-lg focus:ring-violet-500 focus:border-violet-500 transition">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">اسم الموظف</th>
                                    <th scope="col" class="px-6 py-3">الرقم الوظيفي</th>
                                    <th scope="col" class="px-6 py-3">المنصب</th>
                                    <th scope="col" class="px-6 py-3">رصيد الإجازات</th>
                                    <th scope="col" class="px-6 py-3">الحالة</th>
                                    <th scope="col" class="px-6 py-3 text-center">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="employees-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>

            <!-- PAGE: HR Leaves -->
            <main id="page-hr-leaves" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">إدارة الإجازات</h2>
                    <button onclick="openModal('leaveRequestModal')" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">تقديم طلب إجازة</button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">اسم الموظف</th>
                                    <th scope="col" class="px-6 py-3">نوع الإجازة</th>
                                    <th scope="col" class="px-6 py-3">من تاريخ</th>
                                    <th scope="col" class="px-6 py-3">إلى تاريخ</th>
                                    <th scope="col" class="px-6 py-3">المدة (أيام عمل)</th>
                                    <th scope="col" class="px-6 py-3">الحالة</th>
                                    <th scope="col" class="px-6 py-3 text-center">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="leaves-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
            
            <!-- PAGE: HR Salaries -->
            <main id="page-hr-salaries" class="page">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">مسير الرواتب</h2>
                    <button onclick="openModal('generatePayrollModal')" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">إصدار مسير رواتب جديد</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4">سجل مسيرات الرواتب</h3>
                        <div id="payroll-history-container" class="space-y-2 max-h-96 overflow-y-auto">
                        </div>
                    </div>
                    <div id="payroll-details-container" class="lg:col-span-2 hidden">
                    </div>
                </div>
            </main>

            <!-- PAGE: HR Attendance -->
            <main id="page-hr-attendance" class="page">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">سجل الحضور والانصراف</h2>
                    <button onclick="downloadAttendanceTemplate()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">تحميل نموذج ملف الحضور</button>
                 </div>
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">اسم الموظف</th>
                                    <th scope="col" class="px-6 py-3">المنصب</th>
                                    <th scope="col" class="px-6 py-3 text-center">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>

            <!-- PAGE: HR Settings -->
            <main id="page-hr-settings" class="page">
                <h2 class="text-3xl font-bold text-slate-800 mb-6">الإعدادات</h2>
                <div id="settings-menu-container" class="settings-page-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div onclick="showSettingsSection('company-settings-section')" class="module-card bg-white p-8 rounded-2xl shadow-lg text-center cursor-pointer flex flex-col items-center justify-center h-48">
                             <div class="bg-violet-100 text-violet-600 rounded-full h-20 w-20 flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0v-4m0 4h2m0 0v-4m0 4h2m0 0v-4m0 4h2m0 0v-4m-2-4h2v-2h-2v2z" />
                                </svg>
                             </div>
                             <h3 class="text-xl font-bold text-slate-800">إعدادات الشركة</h3>
                        </div>
                        <div onclick="showSettingsSection('leave-types-section')" class="module-card bg-white p-8 rounded-2xl shadow-lg text-center cursor-pointer flex flex-col items-center justify-center h-48">
                            <div class="bg-blue-100 text-blue-600 rounded-full h-20 w-20 flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800">إعدادات أنواع الإجازات</h3>
                        </div>
                    </div>
                </div>
                <div id="company-settings-section" class="settings-page-section">
                    <button onclick="showSettingsSection('settings-menu-container')" class="mb-6 bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">&larr; العودة إلى قائمة الإعدادات</button>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center text-xl font-bold text-slate-800 mb-4 border-b pb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0v-4m0 4h2m0 0v-4m0 4h2m0 0v-4m0 4h2m0 0v-4m-2-4h2v-2h-2v2z" />
                            </svg>
                            <span>إعدادات الشركة</span>
                        </div>
                        <form id="settings-form">
                            <div class="space-y-6">
                                <div>
                                    <label for="company-name-input" class="block mb-2 text-sm font-medium text-gray-900">اسم الشركة</label>
                                    <input type="text" id="company-name-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5" placeholder="أدخل اسم شركتك هنا">
                                </div>
                                <div>
                                    <label for="company-address-input" class="block mb-2 text-sm font-medium text-gray-900">عنوان الشركة</label>
                                    <input type="text" id="company-address-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5" placeholder="مثال: الرياض، المملكة العربية السعودية">
                                </div>
                                <div>
                                    <label for="company-cr-input" class="block mb-2 text-sm font-medium text-gray-900">رقم السجل التجاري</label>
                                    <input type="text" id="company-cr-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5" placeholder="1234567890">
                                </div>
                                <div>
                                    <label for="company-start-time-input" class="block mb-2 text-sm font-medium text-gray-900">وقت بدء الدوام الرسمي</label>
                                    <input type="time" id="company-start-time-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5">
                                </div>
                            </div>
                            <div class="mt-8 pt-4 border-t">
                                <button type="submit" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">حفظ إعدادات الشركة</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="leave-types-section" class="settings-page-section">
                    <button onclick="showSettingsSection('settings-menu-container')" class="mb-6 bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">&larr; العودة إلى قائمة الإعدادات</button>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center text-xl font-bold text-slate-800 mb-4 border-b pb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-3 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span>إعدادات أنواع الإجازات</span>
                        </div>
                        <form id="leave-type-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end mb-6">
                            <input type="hidden" id="leave-type-edit-id">
                            <div class="lg:col-span-2">
                                <label for="leave-type-name" class="block mb-2 text-sm font-medium">اسم الإجازة</label>
                                <input type="text" id="leave-type-name" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2.5" required>
                            </div>
                            <div>
                                <label for="leave-type-days" class="block mb-2 text-sm font-medium">الأيام</label>
                                <input type="number" id="leave-type-days" min="0" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2.5" required>
                            </div>
                            <div>
                                <label for="leave-type-payment" class="block mb-2 text-sm font-medium">الأجر</label>
                                <select id="leave-type-payment" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2.5">
                                    <option value="paid">مدفوعة</option>
                                    <option value="paid_in_advance">مدفوعة مقدماً</option>
                                    <option value="unpaid">بدون أجر</option>
                                </select>
                            </div>
                            <div>
                                <label for="leave-type-recurring" class="block mb-2 text-sm font-medium">التكرار</label>
                                <select id="leave-type-recurring" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2.5">
                                    <option value="annually">سنوي</option>
                                    <option value="once">مرة واحدة</option>
                                    <option value="multiple_per_year">متعددة سنوياً</option>
                                    <option value="none">غير متكرر</option>
                                </select>
                            </div>
                            <button type="submit" id="leave-type-submit-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors h-fit md:col-span-3 lg:col-span-1">إضافة نوع</button>
                        </form>
                        <div class="overflow-x-auto mt-6">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="px-6 py-3">اسم الإجازة</th>
                                        <th class="px-6 py-3">الأيام</th>
                                        <th class="px-6 py-3">الأجر</th>
                                        <th class="px-6 py-3">التكرار</th>
                                        <th class="px-6 py-3">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="leave-types-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="addEmployeeModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0 overflow-y-auto">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 transform scale-95 my-8">
            <h3 id="employeeModalTitle" class="text-xl font-bold mb-4">إضافة موظف جديد</h3>
            <form id="addEmployeeForm">
                <input type="hidden" id="employee-edit-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label for="employeeName" class="block mb-2 text-sm font-medium">الاسم الكامل</label><input type="text" id="employeeName" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div><label for="employeeId" class="block mb-2 text-sm font-medium">الرقم الوظيفي</label><input type="text" id="employeeId" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div><label for="employeeNationalId" class="block mb-2 text-sm font-medium">رقم الهوية/الإقامة</label><input type="text" id="employeeNationalId" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div><label for="employeePosition" class="block mb-2 text-sm font-medium">المنصب الوظيفي</label><input type="text" id="employeePosition" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div><label for="employeeDepartment" class="block mb-2 text-sm font-medium">القسم</label><input type="text" id="employeeDepartment" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div><label for="employeeStartDate" class="block mb-2 text-sm font-medium">تاريخ بدء العمل</label><input type="date" id="employeeStartDate" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div><label for="employeeSalary" class="block mb-2 text-sm font-medium">الراتب الأساسي (ر.س)</label><input type="number" id="employeeSalary" min="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div><label for="employeeNationality" class="block mb-2 text-sm font-medium">الجنسية</label><input type="text" id="employeeNationality" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" placeholder="مثال: سعودي"></div>
                    <div><label for="employeeIBAN" class="block mb-2 text-sm font-medium">رقم الآيبان (IBAN)</label><input type="text" id="employeeIBAN" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" placeholder="SAXXXXXXXXXXXXXXXXXXXXXX"></div>
                    <div><label for="employeeStatus" class="block mb-2 text-sm font-medium">حالة الموظف</label><select id="employeeStatus" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required><option value="active">على رأس العمل</option><option value="on_leave">في إجازة</option><option value="terminated">منتهية خدماته</option></select></div>
                    <div><label class="block mb-2 text-sm font-medium">رصيد الإجازة السنوية</label>
                        <div class="flex items-center space-x-4 rtl:space-x-reverse">
                           <label class="flex items-center"><input type="radio" name="annualLeaveEntitlement" value="21" class="ml-2 text-violet-600 focus:ring-violet-500" checked> 21 يوم</label>
                           <label class="flex items-center"><input type="radio" name="annualLeaveEntitlement" value="30" class="ml-2 text-violet-600 focus:ring-violet-500"> 30 يوم</label>
                        </div>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block mb-2 text-sm font-medium">أيام الراحة الأسبوعية</label>
                        <div id="employee-weekend-days-container" class="flex items-center flex-wrap gap-x-4 gap-y-2">
                            <label class="flex items-center"><input type="checkbox" name="employee-weekend" value="Sunday" class="ml-2 rounded text-violet-600 focus:ring-violet-500"> الأحد</label>
                            <label class="flex items-center"><input type="checkbox" name="employee-weekend" value="Monday" class="ml-2 rounded text-violet-600 focus:ring-violet-500"> الإثنين</label>
                            <label class="flex items-center"><input type="checkbox" name="employee-weekend" value="Tuesday" class="ml-2 rounded text-violet-600 focus:ring-violet-500"> الثلاثاء</label>
                            <label class="flex items-center"><input type="checkbox" name="employee-weekend" value="Wednesday" class="ml-2 rounded text-violet-600 focus:ring-violet-500"> الأربعاء</label>
                            <label class="flex items-center"><input type="checkbox" name="employee-weekend" value="Thursday" class="ml-2 rounded text-violet-600 focus:ring-violet-500"> الخميس</label>
                            <label class="flex items-center"><input type="checkbox" name="employee-weekend" value="Friday" class="ml-2 rounded text-violet-600 focus:ring-violet-500"> الجمعة</label>
                            <label class="flex items-center"><input type="checkbox" name="employee-weekend" value="Saturday" class="ml-2 rounded text-violet-600 focus:ring-violet-500"> السبت</label>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t">
                    <h3 class="text-lg font-bold mb-3">قواعد حسم التأخير</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <label class="flex items-center md:col-span-3">
                            <input type="checkbox" id="enableTardinessRule" class="ml-2 rounded text-violet-600 focus:ring-violet-500">
                            تفعيل قاعدة خصم التأخير لهذا الموظف
                        </label>
                        <div>
                            <label for="gracePeriodMinutes" class="block mb-2 text-sm font-medium">فترة السماح (دقائق)</label>
                            <input type="number" id="gracePeriodMinutes" min="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" placeholder="e.g., 15">
                        </div>
                        <div>
                            <label for="deductionHours" class="block mb-2 text-sm font-medium">ساعات الخصم للمخالفة</label>
                            <input type="number" id="deductionHours" min="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" placeholder="e.g., 1">
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse">
                    <button type="button" onclick="closeModal('addEmployeeModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button>
                    <button id="employeeModalSubmitButton" type="submit" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">حفظ الموظف</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="salaryDetailsModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 transform scale-95">
            <h3 class="text-xl font-bold mb-4">تفاصيل راتب: <span id="salary-details-employee-name"></span></h3>
            <input type="hidden" id="salary-details-employee-id">
            <div class="space-y-4">
                <div>
                    <h4 class="font-semibold text-lg">البدلات</h4>
                    <table class="w-full mt-2 text-sm">
                        <tbody id="allowances-table-body"></tbody>
                    </table>
                    <button onclick="addAllowanceRow()" class="mt-2 text-sm text-blue-600 hover:underline">+ إضافة بدل</button>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-semibold text-lg">الخصومات</h4>
                     <table class="w-full mt-2 text-sm">
                        <tbody id="deductions-table-body"></tbody>
                    </table>
                    <button onclick="addDeductionRow()" class="mt-2 text-sm text-blue-600 hover:underline">+ إضافة خصم</button>
                </div>
                <div class="border-t pt-4 mt-4 font-bold text-xl flex justify-between">
                    <span>صافي الراتب (لأغراض المسير):</span>
                    <span id="net-salary-display">0.00 ر.س</span>
                </div>
            </div>
             <div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse">
                <button type="button" onclick="closeModal('salaryDetailsModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="generatePayrollModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 transform scale-95">
            <h3 class="text-xl font-bold mb-4">إصدار مسير رواتب</h3>
            <form id="generatePayrollForm">
                <div class="space-y-4">
                    <div>
                        <label for="payroll-month" class="block mb-2 text-sm font-medium">الشهر</label>
                        <select id="payroll-month" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></select>
                    </div>
                    <div>
                        <label for="payroll-year" class="block mb-2 text-sm font-medium">السنة</label>
                        <input type="number" id="payroll-year" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse">
                    <button type="button" onclick="closeModal('generatePayrollModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button>
                    <button type="submit" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">إصدار</button>
                </div>
            </form>
        </div>
    </div>

    <div id="attendanceModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95">
            <h3 class="text-xl font-bold mb-4">تسجيل الحضور لـ <span id="attendance-employee-name"></span></h3>
            <form id="attendanceForm">
                <input type="hidden" id="attendance-employee-id">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="attendance-month" class="block mb-2 text-sm font-medium">الشهر</label>
                        <select id="attendance-month" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></select>
                    </div>
                    <div>
                        <label for="attendance-year" class="block mb-2 text-sm font-medium">السنة</label>
                        <input type="number" id="attendance-year" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                    </div>
                    <div class="md:col-span-2 bg-slate-100 p-3 rounded-lg text-center">
                        <p class="text-sm">عدد أيام الشهر: <span id="month-days-display" class="font-bold">0</span> يوم</p>
                    </div>
                    <div><label for="attended-days" class="block mb-2 text-sm font-medium">أيام الحضور الفعلية</label><input type="number" id="attended-days" min="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    <div><label for="late-incidents-over-grace" class="block mb-2 text-sm font-medium">عدد مخالفات التأخير</label><input type="number" id="late-incidents-over-grace" min="0" value="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                    <div class="md:col-span-2 grid grid-cols-2 gap-4">
                        <div><label for="late-hours" class="block mb-2 text-sm font-medium">إجمالي ساعات التأخير</label><input type="number" id="late-hours" min="0" value="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <div><label for="late-minutes" class="block mb-2 text-sm font-medium">إجمالي دقائق التأخير</label><input type="number" id="late-minutes" min="0" max="59" value="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                    </div>
                     <div class="md:col-span-2 grid grid-cols-2 gap-4">
                        <div><label for="overtime-hours" class="block mb-2 text-sm font-medium">ساعات الإضافي</label><input type="number" id="overtime-hours" min="0" value="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <div><label for="overtime-minutes" class="block mb-2 text-sm font-medium">دقائق الإضافي</label><input type="number" id="overtime-minutes" min="0" max="59" value="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse">
                    <button type="button" onclick="closeModal('attendanceModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button>
                    <button type="submit" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">حفظ</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="leaveRequestModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95">
            <h3 class="text-xl font-bold mb-4">تقديم طلب إجازة</h3>
            <form id="leaveRequestForm">
                <div class="space-y-4">
                    <div>
                        <label for="leave-employee-id" class="block mb-2 text-sm font-medium">الموظف</label>
                        <select id="leave-employee-id" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required></select>
                    </div>
                    <div>
                        <label for="leave-type" class="block mb-2 text-sm font-medium">نوع الإجازة</label>
                        <select id="leave-type" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required>
                        </select>
                    </div>
                    <div id="leave-balance-info" class="hidden bg-slate-100 p-3 rounded-lg text-sm space-y-1 mt-2">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="leave-start-date" class="block mb-2 text-sm font-medium">تاريخ البدء</label>
                            <input type="date" id="leave-start-date" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="leave-end-date" class="block mb-2 text-sm font-medium">تاريخ الانتهاء</label>
                            <input type="date" id="leave-end-date" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required>
                        </div>
                    </div>
                    <div>
                        <label for="leave-reason" class="block mb-2 text-sm font-medium">السبب / ملاحظات (اختياري)</label>
                        <textarea id="leave-reason" rows="3" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse">
                    <button type="button" onclick="closeModal('leaveRequestModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button>
                    <button type="submit" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">تقديم الطلب</button>
                </div>
            </form>
        </div>
    </div>

    <div id="attendanceUploadModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95">
            <h3 class="text-xl font-bold mb-4">رفع ملف الحضور لـ <span id="upload-attendance-employee-name"></span></h3>
            <form id="attendanceUploadForm">
                <input type="hidden" id="upload-attendance-employee-id">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="upload-attendance-month" class="block mb-2 text-sm font-medium">الشهر</label>
                            <select id="upload-attendance-month" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5"></select>
                        </div>
                        <div>
                            <label for="upload-attendance-year" class="block mb-2 text-sm font-medium">السنة</label>
                            <input type="number" id="upload-attendance-year" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                        </div>
                    </div>
                    <div>
                        <label for="attendance-file-input" class="block mb-2 text-sm font-medium">اختر ملف الحضور (CSV)</label>
                        <input type="file" id="attendance-file-input" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
                    </div>
                    <div id="attendance-upload-summary" class="hidden bg-slate-100 p-4 rounded-lg text-sm space-y-2">
                    </div>
                    <div id="attendance-upload-edit-fields" class="hidden mt-4 space-y-4 border-t pt-4">
                        <h4 class="font-bold">تعديل البيانات المستخرجة</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="upload-attended-days" class="block mb-2 text-sm font-medium">أيام الحضور الفعلية</label>
                                <input type="number" id="upload-attended-days" min="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5" required>
                            </div>
                            <div>
                                <label for="upload-late-incidents" class="block mb-2 text-sm font-medium">عدد مخالفات التأخير</label>
                                <input type="number" id="upload-late-incidents" min="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                            </div>
                            <div>
                                <label for="upload-late-hours" class="block mb-2 text-sm font-medium">إجمالي ساعات التأخير</label>
                                <input type="number" id="upload-late-hours" min="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                            </div>
                            <div>
                                <label for="upload-late-minutes" class="block mb-2 text-sm font-medium">إجمالي دقائق التأخير</label>
                                <input type="number" id="upload-late-minutes" min="0" max="59" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                            </div>
                            <div>
                                <label for="upload-overtime-hours" class="block mb-2 text-sm font-medium">ساعات الإضافي</label>
                                <input type="number" id="upload-overtime-hours" min="0" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                            </div>
                            <div>
                                <label for="upload-overtime-minutes" class="block mb-2 text-sm font-medium">دقائق الإضافي</label>
                                <input type="number" id="upload-overtime-minutes" min="0" max="59" class="bg-slate-50 border border-slate-300 text-sm rounded-lg block w-full p-2.5">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-2 rtl:space-x-reverse">
                    <button type="button" onclick="closeModal('attendanceUploadModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition-colors">إلغاء</button>
                    <button type="button" id="process-attendance-file-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">معالجة الملف</button>
                    <button type="submit" id="save-processed-attendance-btn" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-colors hidden">اعتماد وحفظ</button>
                </div>
            </form>
        </div>
    </div>


    <div id="alertModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h3 id="alertModalTitle" class="text-xl font-bold mb-4"></h3>
            <p id="alertModalMessage" class="mb-6"></p>
            <div id="alertModalButtons" class="flex justify-center space-x-2 rtl:space-x-reverse"></div>
        </div>
    </div>

    <div id="printable-payroll"></div>

    <script type="module">
        // استيراد وحدات Firebase
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, deleteDoc, query, where, getDocs, updateDoc, writeBatch, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- متغيرات عامة ---
        let app, auth, db, userId;
        let employeesUnsubscribe, payrollsUnsubscribe, settingsUnsubscribe, leavesUnsubscribe, leaveTypesUnsubscribe;
        let allowancesUnsubscribe, deductionsUnsubscribe;
        let state = { 
            employees: [], 
            payrolls: [],
            leaves: [],
            leaveTypes: [],
            settings: { 
                name: 'شركتك', 
                address: '',
                crNumber: '',
                startTime: '09:00',
            },
            currentEmployee: {
                allowances: [],
                deductions: []
            }
        };
        let confirmationCallback = null;
        let departmentChart = null;
        
        const DEFAULT_LEAVE_POLICIES = {
            annual: { name: 'إجازة سنوية', isStandard: true, paymentType: 'paid_in_advance', recurring: 'annually', days: 0 },
            sick: { name: 'إجازة مرضية', isStandard: true, paymentType: 'paid', recurring: 'annually', days: 120 },
            unpaid: { name: 'إجازة بدون أجر', isStandard: true, paymentType: 'unpaid', recurring: 'none', days: 0 },
            maternity: { name: 'إجازة وضع', days: 70, isStandard: true, paymentType: 'paid', recurring: 'none'},
            marriage: { name: 'إجازة زواج', days: 5, isStandard: true, paymentType: 'paid', recurring: 'multiple_per_year'},
            bereavement: { name: 'إجازة وفاة', days: 5, isStandard: true, paymentType: 'paid', recurring: 'multiple_per_year'},
            hajj: { name: 'إجازة حج', days: 14, isStandard: true, paymentType: 'paid', recurring: 'once'},
            child_care: { name: 'إجازة رعاية طفل', isStandard: true, paymentType: 'unpaid', recurring: 'none', days: 180},
            new_born: { name: 'إجازة مولود', days: 3, isStandard: true, paymentType: 'paid', recurring: 'multiple_per_year'},
            eid_fitr: { name: 'إجازة عيد الفطر', days: 4, isStandard: true, paymentType: 'paid', recurring: 'annually'},
            eid_adha: { name: 'إجازة عيد الأضحى', days: 4, isStandard: true, paymentType: 'paid', recurring: 'annually'},
            national_day: { name: 'إجازة اليوم الوطني', days: 1, isStandard: true, paymentType: 'paid', recurring: 'annually'},
            foundation_day: { name: 'إجازة يوم التأسيس', days: 1, isStandard: true, paymentType: 'paid', recurring: 'annually'},
        };


        // --- عناصر واجهة المستخدم ---
        const ui = {
            hrModuleContainer: document.getElementById('hr-module-container'),
            addEmployeeForm: document.getElementById('addEmployeeForm'),
            employeesTableBody: document.getElementById('employees-table-body'),
            attendanceTableBody: document.getElementById('attendance-table-body'),
            leavesTableBody: document.getElementById('leaves-table-body'),
            hrDashboardStats: document.getElementById('hr-dashboard-stats'),
            pendingLeavesDashboard: document.getElementById('pending-leaves-dashboard'),
            employeeModalTitle: document.getElementById('employeeModalTitle'),
            employeeModalSubmitButton: document.getElementById('employeeModalSubmitButton'),
            employeeEditIdInput: document.getElementById('employee-edit-id'),
            payrollHistoryContainer: document.getElementById('payroll-history-container'),
            payrollDetailsContainer: document.getElementById('payroll-details-container'),
            generatePayrollForm: document.getElementById('generatePayrollForm'),
            attendanceForm: document.getElementById('attendanceForm'),
            attendanceUploadForm: document.getElementById('attendanceUploadForm'),
            leaveRequestForm: document.getElementById('leaveRequestForm'),
            settingsForm: document.getElementById('settings-form'),
            companyNameInput: document.getElementById('company-name-input'),
            companyAddressInput: document.getElementById('company-address-input'),
            companyCRInput: document.getElementById('company-cr-input'),
            companyStartTimeInput: document.getElementById('company-start-time-input'),
            leaveTypeForm: document.getElementById('leave-type-form'),
            leaveTypesTableBody: document.getElementById('leave-types-table-body'),
        };

        // --- Utility Functions ---
        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function formatNumber(value, fractionDigits = 2) {
            return Number(value).toLocaleString('en-US', {
                minimumFractionDigits: fractionDigits,
                maximumFractionDigits: fractionDigits,
                useGrouping: true
            });
        }

        function formatInteger(value) {
            return Number(value).toLocaleString('en-US', { useGrouping: false });
        }

        function formatGregorianDate(dateStringOrObject) {
            if (!dateStringOrObject) return '';
            const date = dateStringOrObject.toDate ? dateStringOrObject.toDate() : new Date(dateStringOrObject);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function calculateWorkingDays(startDateStr, endDateStr, employeeWeekendDaysArray = []) {
            let count = 0;
            const curDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            const weekendMap = { 'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5, 'Saturday': 6 };
            const weekendDays = (employeeWeekendDaysArray || []).map(day => weekendMap[day]);

            while (curDate <= endDate) {
                const dayOfWeek = curDate.getDay();
                if (!weekendDays.includes(dayOfWeek)) {
                    count++;
                }
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        }

        function calculateWorkDaysInMonth(year, month, employeeWeekendDaysArray = []) {
            let workDays = 0;
            const endDate = new Date(year, month + 1, 0);
             const weekendMap = { 'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 'Thursday': 4, 'Friday': 5, 'Saturday': 6 };
            const weekendDays = (employeeWeekendDaysArray || []).map(day => weekendMap[day]);

            for (let day = 1; day <= endDate.getDate(); day++) {
                const currentDate = new Date(year, month, day);
                if (!weekendDays.includes(currentDate.getDay())) {
                    workDays++;
                }
            }
            return workDays;
        }


        // --- Modal & Alert Functions ---
        window.openModal = async (modalId, context = null) => {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            if (modalId === 'addEmployeeModal') {
                ui.addEmployeeForm.reset();
                ui.employeeEditIdInput.value = '';
                document.querySelector('input[name="annualLeaveEntitlement"][value="21"]').checked = true;
                document.querySelectorAll('input[name="employee-weekend"]').forEach(cb => cb.checked = false);
                document.getElementById('enableTardinessRule').checked = false;

                if (context) { // Edit
                    const employee = state.employees.find(emp => emp.id === context);
                    if (employee) {
                        ui.employeeModalTitle.textContent = 'تعديل بيانات الموظف';
                        ui.employeeModalSubmitButton.textContent = 'حفظ التعديلات';
                        ui.employeeEditIdInput.value = employee.id;
                        document.getElementById('employeeName').value = employee.name;
                        document.getElementById('employeeId').value = employee.employeeId;
                        document.getElementById('employeeNationalId').value = employee.nationalId || '';
                        document.getElementById('employeePosition').value = employee.position;
                        document.getElementById('employeeDepartment').value = employee.department;
                        document.getElementById('employeeStartDate').value = employee.startDate;
                        document.getElementById('employeeSalary').value = employee.salary;
                        document.getElementById('employeeStatus').value = employee.status;
                        document.getElementById('employeeNationality').value = employee.nationality || '';
                        document.getElementById('employeeIBAN').value = employee.iban || '';
                        if (employee.annualLeaveEntitlement) {
                            const radio = document.querySelector(`input[name="annualLeaveEntitlement"][value="${employee.annualLeaveEntitlement}"]`);
                            if(radio) radio.checked = true;
                        }
                        if (employee.weekendDays && Array.isArray(employee.weekendDays)) {
                            employee.weekendDays.forEach(day => {
                                const checkbox = document.querySelector(`input[name="employee-weekend"][value="${day}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        if (employee.tardinessRule) {
                            document.getElementById('enableTardinessRule').checked = employee.tardinessRule.enabled || false;
                            document.getElementById('gracePeriodMinutes').value = employee.tardinessRule.gracePeriodMinutes || '';
                            document.getElementById('deductionHours').value = employee.tardinessRule.deductionHours || '';
                        }
                    }
                } else { // Add
                    ui.employeeModalTitle.textContent = 'إضافة موظف جديد';
                    ui.employeeModalSubmitButton.textContent = 'حفظ الموظف';
                    document.getElementById('employeeStartDate').valueAsDate = new Date();
                }
            } else if (modalId === 'salaryDetailsModal') {
                openSalaryDetailsModal(context);
            } else if (modalId === 'leaveRequestModal') {
                ui.leaveRequestForm.reset();
                const employeeSelect = document.getElementById('leave-employee-id');
                employeeSelect.innerHTML = state.employees.filter(e => e.status === 'active').map(e => `<option value="${e.id}">${e.name} (${e.employeeId})</option>`).join('');
                document.getElementById('leave-start-date').valueAsDate = new Date();
                document.getElementById('leave-end-date').valueAsDate = new Date();
                document.getElementById('leave-balance-info').classList.add('hidden');
                populateLeaveTypeDropdown();
                updateLeaveBalanceDisplay();
            } else if (modalId === 'attendanceUploadModal') {
                const employee = state.employees.find(e => e.id === context);
                if (employee) {
                    document.getElementById('upload-attendance-employee-name').textContent = employee.name;
                    document.getElementById('upload-attendance-employee-id').value = employee.id;
                    const monthSelect = document.getElementById('upload-attendance-month');
                    const yearInput = document.getElementById('upload-attendance-year');
                    const now = new Date();
                    const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
                    monthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
                    monthSelect.value = now.getMonth();
                    yearInput.value = now.getFullYear();
                    document.getElementById('attendance-upload-summary').classList.add('hidden');
                    document.getElementById('attendance-upload-edit-fields').classList.add('hidden');
                    document.getElementById('save-processed-attendance-btn').classList.add('hidden');
                    document.getElementById('process-attendance-file-btn').classList.remove('hidden');
                    ui.attendanceUploadForm.reset();
                }
            } else if (modalId === 'attendanceModal') {
                const employee = state.employees.find(e => e.id === context);
                if (employee) {
                    const monthSelect = document.getElementById('attendance-month');
                    const yearInput = document.getElementById('attendance-year');
                    const now = new Date();
                    const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
                    monthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
                    ui.attendanceForm.reset();
                    monthSelect.value = now.getMonth();
                    yearInput.value = now.getFullYear();
                    document.getElementById('attendance-employee-name').textContent = employee.name;
                    document.getElementById('attendance-employee-id').value = employee.id;
                    updateMonthDaysDisplay();
                    const attendanceId = `${yearInput.value}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    const attendanceDocRef = doc(db, "hr-data", userId, "employees", employee.id, "attendance", attendanceId);
                    const docSnap = await getDoc(attendanceDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('attended-days').value = data.attendedDays || 0;
                        document.getElementById('late-hours').value = data.lateHours || 0;
                        document.getElementById('late-minutes').value = data.lateMinutes || 0;
                        document.getElementById('overtime-hours').value = data.overtimeHours || 0;
                        document.getElementById('overtime-minutes').value = data.overtimeMinutes || 0;
                        document.getElementById('late-incidents-over-grace').value = data.lateIncidentsOverGrace || 0;
                    }
                }
            } else if (modalId === 'generatePayrollModal') {
                const monthSelect = document.getElementById('payroll-month');
                const yearInput = document.getElementById('payroll-year');
                const now = new Date();
                const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
                monthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
                monthSelect.value = now.getMonth();
                yearInput.value = now.getFullYear();
            }
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
        };

        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                if (modalId === 'salaryDetailsModal') {
                    if (allowancesUnsubscribe) allowancesUnsubscribe();
                    if (deductionsUnsubscribe) deductionsUnsubscribe();
                }
            }, 300);
        };

        const showAlert = (title, message) => {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').innerHTML = message;
            document.getElementById('alertModalButtons').innerHTML = `<button type="button" onclick="closeModal('alertModal')" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">حسنًا</button>`;
            openModal('alertModal');
        };

        const showConfirmation = (title, message, onConfirm) => {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            confirmationCallback = onConfirm;
            document.getElementById('alertModalButtons').innerHTML = `<button type="button" onclick="closeModal('alertModal')" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-6 rounded-lg transition-colors">إلغاء</button><button type="button" onclick="handleConfirm()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">تأكيد</button>`;
            openModal('alertModal');
        };
        window.handleConfirm = () => { if (confirmationCallback) { confirmationCallback(); } closeModal('alertModal'); confirmationCallback = null; };

        // --- Navigation Functions ---
        window.showPage = (pageId) => {
            const module = document.getElementById('hr-module-container');
            if (!module) return;
            module.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            const page = module.querySelector(`#${pageId}`);
            if(page) page.classList.add('active');
            module.querySelectorAll('.sidebar-link').forEach(e => e.classList.remove('active'));
            const activeLink = module.querySelector(`.sidebar-link[onclick*="'${pageId}'"]`);
            if (activeLink) activeLink.classList.add('active');
            if (pageId === 'page-hr-settings') showSettingsSection('settings-menu-container');
        };

        window.showSettingsSection = (sectionId) => {
            document.querySelectorAll('.settings-page-section').forEach(section => section.classList.remove('active'));
            const sectionToShow = document.getElementById(sectionId);
            if(sectionToShow) sectionToShow.classList.add('active');
        };

        // --- Rendering Functions ---
        function renderAll() {
            renderHrDashboard();
            renderEmployeesPage();
            renderLeavesPage();
            renderAttendancePage();
            renderOrUpdateDepartmentChart();
            renderPayrollHistory();
            renderSettingsPage();
            renderLeaveTypesSettings();
        }

        async function renderHrDashboard() {
            if (!ui.hrDashboardStats) return;
            const totalEmployees = state.employees.length;
            const activeEmployees = state.employees.filter(e => e.status === 'active').length;
            const now = new Date();
            const currentlyOnLeave = state.leaves.filter(l => l.status === 'approved' && now >= new Date(l.startDate) && now <= new Date(l.endDate)).length;
            const pendingLeaves = state.leaves.filter(l => l.status === 'pending').length;

            ui.hrDashboardStats.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse">
                    <div class="bg-violet-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div>
                    <div><h3 class="text-slate-500">إجمالي الموظفين</h3><p class="text-2xl font-bold">${formatInteger(totalEmployees)}</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse">
                    <div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div>
                    <div><h3 class="text-slate-500">على رأس العمل</h3><p class="text-2xl font-bold">${formatInteger(activeEmployees)}</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse">
                    <div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <div><h3 class="text-slate-500">في إجازة حالياً</h3><p class="text-2xl font-bold">${formatInteger(currentlyOnLeave)}</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4 rtl:space-x-reverse">
                    <div class="bg-amber-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                    <div><h3 class="text-slate-500">طلبات معلقة</h3><p class="text-2xl font-bold">${formatInteger(pendingLeaves)}</p></div>
                </div>
            `;
            
            const pendingLeavesList = state.leaves.filter(l => l.status === 'pending');
            if(pendingLeavesList.length > 0) {
                ui.pendingLeavesDashboard.innerHTML = pendingLeavesList.map(l => {
                    const emp = state.employees.find(e => e.id === l.employeeId);
                    return `<div class="p-2 border-b text-sm">
                        <p class="font-semibold">${emp ? emp.name : 'موظف غير معروف'}</p>
                        <p class="text-slate-600">${l.startDate} إلى ${l.endDate}</p>
                    </div>`
                }).join('');
            } else {
                ui.pendingLeavesDashboard.innerHTML = `<p class="text-center text-slate-500 p-4">لا توجد طلبات إجازة معلقة.</p>`;
            }
        }

        async function renderEmployeesPage() {
            if (!ui.employeesTableBody) return;
            const searchTerm = document.getElementById('employee-search-input')?.value.toLowerCase() || '';
            const filteredEmployees = state.employees.filter(emp => 
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.employeeId.toLowerCase().includes(searchTerm) ||
                emp.position.toLowerCase().includes(searchTerm)
            );

            if (state.employees.length === 0) {
                ui.employeesTableBody.innerHTML = '<tr class="border-b"><td colspan="6" class="text-center p-4">لا يوجد موظفين مضافين.</td></tr>';
                return;
            }
            if (filteredEmployees.length === 0) {
                ui.employeesTableBody.innerHTML = '<tr class="border-b"><td colspan="6" class="text-center p-4">لا يوجد موظفون يطابقون معايير البحث.</td></tr>';
                return;
            }

            const leavePromises = filteredEmployees.map(async (emp) => {
                const approvedAnnualLeaves = state.leaves.filter(l => 
                    l.employeeId === emp.id && l.status === 'approved' && l.leaveType === 'annual' && new Date(l.startDate).getFullYear() === new Date().getFullYear()
                );
                const daysTaken = approvedAnnualLeaves.reduce((sum, l) => sum + l.duration, 0);
                const balance = (emp.annualLeaveEntitlement || 0) - daysTaken;
                return { ...emp, remainingBalance: balance };
            });

            const employeesWithBalance = await Promise.all(leavePromises);

            ui.employeesTableBody.innerHTML = employeesWithBalance.sort((a, b) => a.name.localeCompare(b.name)).map(emp => {
                const statusClasses = { active: 'bg-green-100 text-green-800', on_leave: 'bg-amber-100 text-amber-800', terminated: 'bg-red-100 text-red-800' };
                const statusText = { active: 'على رأس العمل', on_leave: 'في إجازة', terminated: 'منتهية خدماته' };
                return `<tr class="bg-white border-b hover:bg-slate-50">
                    <td class="px-6 py-4 font-medium text-slate-900">${emp.name}</td>
                    <td class="px-6 py-4">${emp.employeeId}</td>
                    <td class="px-6 py-4">${emp.position}</td>
                    <td class="px-6 py-4 font-semibold">${emp.remainingBalance} / ${emp.annualLeaveEntitlement || 0}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusClasses[emp.status] || ''}">${statusText[emp.status] || emp.status}</span></td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="openModal('salaryDetailsModal', '${emp.id}')" class="text-green-600 hover:text-green-800 font-semibold px-2">الراتب</button>
                        <button onclick="openModal('addEmployeeModal', '${emp.id}')" class="text-blue-600 hover:text-blue-800 font-semibold px-2">تعديل</button>
                        <button onclick="deleteEmployee('${emp.id}')" class="text-red-500 hover:text-red-700 font-semibold px-2">حذف</button>
                    </td>
                </tr>`;
            }).join("");
        }
        
        function renderOrUpdateDepartmentChart() {
            const chartElement = document.getElementById('department-chart');
            if (!chartElement) return;
            const ctx = chartElement.getContext('2d');
            if (state.employees.length === 0) {
                if (departmentChart) { departmentChart.destroy(); departmentChart = null; }
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "16px Cairo"; ctx.textAlign = "center"; ctx.fillStyle = "#9ca3af";
                ctx.fillText("لا توجد بيانات كافية لعرض الرسم البياني", ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const departmentCounts = state.employees.reduce((acc, emp) => {
                acc[emp.department] = (acc[emp.department] || 0) + 1;
                return acc;
            }, {});

            const chartData = {
                labels: Object.keys(departmentCounts),
                datasets: [{
                    label: 'عدد الموظفين',
                    data: Object.values(departmentCounts),
                    backgroundColor: ['#8b5cf6', '#34d399', '#60a5fa', '#f59e0b', '#fb7185', '#14b8a6'],
                    hoverOffset: 4
                }]
            };

            if (departmentChart) { 
                departmentChart.data = chartData; 
                departmentChart.update();
            } else { 
                departmentChart = new Chart(ctx, { 
                    type: 'pie', data: chartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { font: { family: 'Cairo' } } }, tooltip: { bodyFont: { family: 'Cairo' }, titleFont: { family: 'Cairo' } } } } 
                }); 
            }
        }
        
        function renderSettingsPage() {
            if (!ui.companyNameInput) return;
            ui.companyNameInput.value = state.settings.name || '';
            ui.companyAddressInput.value = state.settings.address || '';
            ui.companyCRInput.value = state.settings.crNumber || '';
            ui.companyStartTimeInput.value = state.settings.startTime || '09:00';
        }

        // --- Firebase Functions ---
        function clearDataAndListeners() {
            if (employeesUnsubscribe) employeesUnsubscribe();
            if (payrollsUnsubscribe) payrollsUnsubscribe();
            if (settingsUnsubscribe) settingsUnsubscribe();
            if (leavesUnsubscribe) leavesUnsubscribe();
            if (leaveTypesUnsubscribe) leaveTypesUnsubscribe();
        }

        async function initializeDefaultLeaveTypes() {
            const leaveTypesRef = collection(db, "hr-data", userId, "leave-types");
            const snapshot = await getDocs(leaveTypesRef);
            if (snapshot.empty) {
                const batch = writeBatch(db);
                for (const [key, value] of Object.entries(DEFAULT_LEAVE_POLICIES)) {
                    const docRef = doc(leaveTypesRef, key);
                    batch.set(docRef, value);
                }
                await batch.commit();
            }
        }

        function setupRealtimeListeners() {
            clearDataAndListeners();
            if (!userId) return;

            initializeDefaultLeaveTypes();

            const employeesRef = collection(db, "hr-data", userId, "employees");
            employeesUnsubscribe = onSnapshot(employeesRef, snapshot => {
                state.employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, error => console.error("Employees listener failed:", error));

            const payrollsRef = collection(db, "hr-data", userId, "payrolls");
            payrollsUnsubscribe = onSnapshot(payrollsRef, snapshot => {
                state.payrolls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPayrollHistory();
            });
            
            const settingsRef = doc(db, "hr-data", userId, "settings", "companyProfile");
            settingsUnsubscribe = onSnapshot(settingsRef, (doc) => {
                state.settings = doc.exists() ? { ...state.settings, ...doc.data() } : { name: 'شركتك', address: '', crNumber: '', startTime: '09:00' };
                renderSettingsPage();
            });

            const leavesRef = collection(db, "hr-data", userId, "leaves");
            leavesUnsubscribe = onSnapshot(query(leavesRef), snapshot => {
                state.leaves = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });

            const leaveTypesRef = collection(db, "hr-data", userId, "leave-types");
            leaveTypesUnsubscribe = onSnapshot(leaveTypesRef, snapshot => {
                state.leaveTypes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLeaveTypesSettings();
            });
        }

        // --- HR Data Functions ---
        const handleEmployeeFormSubmit = async (event) => {
            event.preventDefault();
            const form = event.target;
            const weekendCheckboxes = form.querySelectorAll('input[name="employee-weekend"]:checked');
            const selectedWeekends = Array.from(weekendCheckboxes).map(cb => cb.value);

            const employeeData = {
                name: form.employeeName.value.trim(),
                employeeId: form.employeeId.value.trim(),
                nationalId: form.employeeNationalId.value.trim(),
                position: form.employeePosition.value.trim(),
                department: form.employeeDepartment.value.trim(),
                startDate: form.employeeStartDate.value,
                salary: Number(form.employeeSalary.value),
                status: form.employeeStatus.value,
                nationality: form.employeeNationality.value.trim(),
                iban: form.employeeIBAN.value.trim(),
                annualLeaveEntitlement: Number(form.annualLeaveEntitlement.value),
                weekendDays: selectedWeekends,
                tardinessRule: {
                    enabled: form.enableTardinessRule.checked,
                    gracePeriodMinutes: Number(form.gracePeriodMinutes.value) || 0,
                    deductionHours: Number(form.deductionHours.value) || 0,
                }
            };
            if (!employeeData.name || !employeeData.employeeId || !employeeData.nationalId) return showAlert("بيانات ناقصة", "يرجى إدخال اسم الموظف، ورقمه الوظيفي، ورقم الهوية/الإقامة.");
            
            try {
                const editId = ui.employeeEditIdInput.value;
                if (editId) {
                    await updateDoc(doc(db, "hr-data", userId, "employees", editId), employeeData);
                    showAlert("نجاح", "تم تعديل بيانات الموظف بنجاح.");
                } else {
                    const q = query(collection(db, "hr-data", userId, "employees"), where("employeeId", "==", employeeData.employeeId));
                    if (!(await getDocs(q)).empty) return showAlert("خطأ", "الرقم الوظيفي المدخل موجود بالفعل لموظف آخر.");
                    await addDoc(collection(db, "hr-data", userId, "employees"), employeeData);
                    showAlert("نجاح", "تمت إضافة الموظف بنجاح.");
                }
                closeModal("addEmployeeModal");
            } catch (err) {
                showAlert("خطأ فني", "حدث خطأ أثناء حفظ البيانات.");
                console.error("Error handling employee form:", err);
            }
        };

        window.deleteEmployee = (docId) => {
            showConfirmation("تأكيد الحذف", "هل أنت متأكد من حذف هذا الموظف؟ سيتم حذف جميع البيانات المرتبطة به.", async () => {
                try {
                    await deleteDoc(doc(db, "hr-data", userId, "employees", docId));
                    showAlert("نجاح", "تم حذف الموظف بنجاح.");
                } catch (err) {
                    showAlert("خطأ", "فشلت عملية حذف الموظف.");
                    console.error("Error deleting employee:", err);
                }
            });
        };

        // --- Salary Details Functions ---
        const openSalaryDetailsModal = (employeeId) => {
            const employee = state.employees.find(e => e.id === employeeId);
            if (!employee) return;
            document.getElementById('salary-details-employee-name').textContent = employee.name;
            document.getElementById('salary-details-employee-id').value = employee.id;
            allowancesUnsubscribe = onSnapshot(collection(db, "hr-data", userId, "employees", employeeId, "allowances"), s => {
                state.currentEmployee.allowances = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderSalaryAdjustments('allowances');
                updateNetSalary();
            });
            deductionsUnsubscribe = onSnapshot(collection(db, "hr-data", userId, "employees", employeeId, "deductions"), s => {
                state.currentEmployee.deductions = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderSalaryAdjustments('deductions');
                updateNetSalary();
            });
        };

        const renderSalaryAdjustments = (type) => {
            const tableBody = document.getElementById(`${type}-table-body`);
            tableBody.innerHTML = state.currentEmployee[type].map(item => `
                <tr class="border-b">
                    <td class="p-2 w-1/3">${item.name}</td>
                    <td class="p-2 w-1/3">${formatNumber(item.amount)} ر.س</td>
                    <td class="p-2 w-1/3 text-left flex items-center justify-end">
                        <span class="text-xs mr-2">${item.includedInPayroll ? 'يحتسب بالراتب' : 'لا يحتسب'}</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none"><input type="checkbox" onchange="toggleInclusion('${type}', '${item.id}', this.checked)" id="toggle-${type}-${item.id}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${item.includedInPayroll ? 'checked' : ''}/><label for="toggle-${type}-${item.id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div>
                        <button onclick="deleteSalaryAdjustment('${type}', '${item.id}')" class="text-red-500 hover:text-red-700">حذف</button>
                    </td>
                </tr>`).join('');
        };

        const addAdjustmentRow = (type) => {
            const tableBody = document.getElementById(`${type}-table-body`);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-2"><input type="text" placeholder="البند" class="w-full p-1 border rounded"></td><td class="p-2"><input type="number" placeholder="المبلغ" class="w-full p-1 border rounded"></td><td class="p-2 text-left"><button class="text-green-500 hover:text-green-700">حفظ</button></td>`;
            tr.querySelector('button').onclick = () => saveSalaryAdjustment(type, tr);
            tableBody.appendChild(tr);
        };
        window.addAllowanceRow = () => addAdjustmentRow('allowances');
        window.addDeductionRow = () => addAdjustmentRow('deductions');

        const saveSalaryAdjustment = async (type, tr) => {
            const name = tr.querySelector('input[type="text"]').value.trim();
            const amount = parseFloat(tr.querySelector('input[type="number"]').value);
            if (!name || isNaN(amount) || amount <= 0) return showAlert('بيانات ناقصة', 'يرجى إدخال اسم البند ومبلغ صحيح.');
            try {
                await addDoc(collection(db, "hr-data", userId, "employees", document.getElementById('salary-details-employee-id').value, type), { name, amount, includedInPayroll: true });
            } catch (e) { showAlert('خطأ', 'فشل حفظ البند.'); }
        };
        
        window.deleteSalaryAdjustment = async (type, docId) => {
            try {
                await deleteDoc(doc(db, "hr-data", userId, "employees", document.getElementById('salary-details-employee-id').value, type, docId));
            } catch(e) { showAlert('خطأ', 'فشل حذف البند.'); }
        };
        
        window.toggleInclusion = async (type, docId, isIncluded) => {
             try {
                await updateDoc(doc(db, "hr-data", userId, "employees", document.getElementById('salary-details-employee-id').value, type, docId), { includedInPayroll: isIncluded });
            } catch(e) { showAlert('خطأ', 'فشل تحديث حالة البند.'); }
        };

        const updateNetSalary = () => {
            const employee = state.employees.find(e => e.id === document.getElementById('salary-details-employee-id').value);
            if (!employee) return;
            const netSalary = (Number(employee.salary) || 0) + state.currentEmployee.allowances.filter(a => a.includedInPayroll).reduce((s, i) => s + Number(i.amount), 0) - state.currentEmployee.deductions.filter(d => d.includedInPayroll).reduce((s, i) => s + Number(i.amount), 0);
            document.getElementById('net-salary-display').textContent = `${formatNumber(netSalary)} ر.س`;
        };
        
        // --- Leave Management Functions ---
        function renderLeavesPage() {
            if (!ui.leavesTableBody) return;
            if (state.leaves.length === 0) {
                ui.leavesTableBody.innerHTML = `<tr class="border-b"><td colspan="7" class="text-center p-4">لا توجد طلبات إجازة.</td></tr>`;
                return;
            }
            const statusClasses = { pending: 'bg-amber-100 text-amber-800', approved: 'bg-green-100 text-green-800', rejected: 'bg-red-100 text-red-800' };
            const statusText = { pending: 'معلق', approved: 'موافق عليه', rejected: 'مرفوض' };
            const allLeaveTypes = Object.fromEntries(state.leaveTypes.map(lt => [lt.id, lt]));
            ui.leavesTableBody.innerHTML = state.leaves.sort((a,b) => new Date(b.startDate) - new Date(a.startDate)).map(l => {
                const emp = state.employees.find(e => e.id === l.employeeId);
                const leavePolicy = allLeaveTypes[l.leaveType] || { name: l.leaveType };
                const actions = l.status === 'pending' ? `<button onclick="approveLeave('${l.id}')" class="text-green-600 hover:text-green-800 font-semibold px-2">موافقة</button><button onclick="rejectLeave('${l.id}')" class="text-orange-600 hover:text-orange-800 font-semibold px-2">رفض</button><button onclick="deleteLeave('${l.id}')" class="text-red-500 hover:text-red-700 font-semibold px-2">حذف</button>` : `<button onclick="deleteLeave('${l.id}')" class="text-red-500 hover:text-red-700 font-semibold px-2">حذف</button>`;
                return `<tr class="bg-white border-b hover:bg-slate-50">
                    <td class="px-6 py-4 font-medium text-slate-900">${emp ? emp.name : 'غير معروف'}</td>
                    <td class="px-6 py-4">${leavePolicy.name}</td>
                    <td class="px-6 py-4">${l.startDate}</td>
                    <td class="px-6 py-4">${l.endDate}</td>
                    <td class="px-6 py-4">${l.duration}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusClasses[l.status] || ''}">${statusText[l.status] || l.status}</span></td>
                    <td class="px-6 py-4 text-center">${actions}</td>
                </tr>`;
            }).join('');
        }

        async function updateLeaveBalanceDisplay() {
            const employeeId = document.getElementById('leave-employee-id').value;
            const leaveTypeKey = document.getElementById('leave-type').value;
            const balanceInfoDiv = document.getElementById('leave-balance-info');
            if (!employeeId || !leaveTypeKey) return balanceInfoDiv.classList.add('hidden');
            const employee = state.employees.find(e => e.id === employeeId);
            let policy = state.leaveTypes.find(lt => lt.id === leaveTypeKey);
            if (!employee || !policy) return;

            let totalEntitlement = 0, daysTaken = 0, message = '', showBalance = false;
            const currentYear = new Date().getFullYear();
            const leavesOfType = state.leaves.filter(l => l.employeeId === employeeId && l.leaveType === leaveTypeKey && l.status === 'approved');

            if (policy.recurring === 'annually') {
                 totalEntitlement = (leaveTypeKey === 'annual') ? (employee.annualLeaveEntitlement || 0) : policy.days;
                daysTaken = leavesOfType.filter(l => new Date(l.startDate).getFullYear() === currentYear).reduce((s, l) => s + l.duration, 0);
                showBalance = true;
            } else if (policy.recurring === 'once') {
                totalEntitlement = policy.days;
                daysTaken = leavesOfType.reduce((s, l) => s + l.duration, 0);
                if (daysTaken >= totalEntitlement) message = `<p class="text-red-600 font-bold">تم استنفاذ رصيد هذه الإجازة.</p>`;
                showBalance = true;
            } else if (policy.recurring === 'multiple_per_year') {
                message = `<p>المدة المسموحة: ${policy.days} يوم لكل حالة.</p>`;
            }

            if (leaveTypeKey === 'sick') {
                const sickLeaveYearStart = employee.firstSickLeaveDate ? new Date(employee.firstSickLeaveDate) : null;
                let sickLeaveYear = currentYear;
                if(sickLeaveYearStart && sickLeaveYearStart.getFullYear() < currentYear) sickLeaveYear = sickLeaveYearStart.getFullYear();
                daysTaken = state.leaves.filter(l => l.employeeId === employeeId && l.leaveType === 'sick' && l.status === 'approved' && new Date(l.startDate).getFullYear() >= sickLeaveYear).reduce((s, l) => s + l.duration, 0);
                message = `<p>الأيام المأخوذة في السنة المرضية الحالية: ${daysTaken} يوم.</p><p class="text-xs text-slate-500">تحتسب حسب نظام العمل: 30 يوم بأجر كامل، ثم 60 يوم بـ 75% من الأجر، ثم 30 يوم بدون أجر.</p>`;
                showBalance = false;
            }

            if (showBalance) {
                const remainingBalance = totalEntitlement - daysTaken;
                balanceInfoDiv.innerHTML = `<p><strong>الرصيد الكلي:</strong> ${totalEntitlement} يوم</p><p><strong>الأيام المأخوذة:</strong> ${daysTaken} يوم</p><p class="font-bold"><strong>الرصيد المتبقي:</strong> <span class="${remainingBalance > 0 ? 'text-green-600' : 'text-red-600'}">${remainingBalance}</span> يوم</p>${message}`;
                balanceInfoDiv.classList.remove('hidden');
            } else if (message) {
                balanceInfoDiv.innerHTML = message;
                balanceInfoDiv.classList.remove('hidden');
            } else {
                balanceInfoDiv.classList.add('hidden');
            }
        }

        const handleLeaveRequestSubmit = async (event) => {
            event.preventDefault();
            const form = event.target;
            const employeeId = form['leave-employee-id'].value;
            const employee = state.employees.find(e => e.id === employeeId);
            const startDate = form['leave-start-date'].value;
            const endDate = form['leave-end-date'].value;
            const leaveTypeKey = form['leave-type'].value;

            if (!employeeId || !startDate || !endDate || !leaveTypeKey) return showAlert('بيانات ناقصة', 'يرجى ملء جميع الحقول المطلوبة.');
            if (new Date(endDate) < new Date(startDate)) return showAlert('خطأ في التاريخ', 'تاريخ انتهاء الإجازة يجب أن يكون بعد تاريخ البدء.');
            const duration = calculateWorkingDays(startDate, endDate, employee.weekendDays);
            if (duration <= 0) return showAlert('خطأ في المدة', 'مدة الإجازة المحددة تقع بالكامل في عطلة نهاية الأسبوع أو أن المدة صفر.');
            let policy = state.leaveTypes.find(lt => lt.id === leaveTypeKey);
            if (!policy) return showAlert('خطأ', 'نوع الإجازة غير معروف.');

            const leavesOfType = state.leaves.filter(l => l.employeeId === employeeId && l.leaveType === leaveTypeKey && l.status === 'approved');
            if (policy.recurring === 'once' && leavesOfType.reduce((s, l) => s + l.duration, 0) >= policy.days) return showAlert('رصيد مستنفذ', `سبق للموظف الحصول على إجازة ${policy.name}.`);
            if (policy.recurring === 'multiple_per_year' && duration > policy.days) return showAlert('المدة تجاوزت الحد', `المدة المسموحة لإجازة ${policy.name} هي ${policy.days} أيام فقط لكل حالة.`);
            if (policy.recurring === 'annually' && leaveTypeKey === 'annual') {
                const balance = (employee.annualLeaveEntitlement || 0) - leavesOfType.filter(l => new Date(l.startDate).getFullYear() === new Date(startDate).getFullYear()).reduce((s, l) => s + l.duration, 0);
                if (duration > balance) return showAlert('رصيد غير كافٍ', `رصيد الإجازات السنوية للموظف هو ${balance} يوم فقط.`);
            }

            try {
                await addDoc(collection(db, "hr-data", userId, "leaves"), { employeeId, leaveType: leaveTypeKey, startDate, endDate, duration, reason: form['leave-reason'].value.trim(), status: 'pending', submittedAt: serverTimestamp() });
                showAlert('نجاح', 'تم تقديم طلب الإجازة بنجاح.');
                closeModal('leaveRequestModal');
            } catch (e) { showAlert('خطأ', 'فشل تقديم طلب الإجازة.'); }
        };

        window.approveLeave = async (leaveId) => {
            try { await updateDoc(doc(db, "hr-data", userId, "leaves", leaveId), { status: 'approved' }); showAlert('نجاح', 'تمت الموافقة على طلب الإجازة.'); } catch (e) { showAlert('خطأ', 'فشلت عملية الموافقة.'); }
        };
        window.rejectLeave = async (leaveId) => {
            try { await updateDoc(doc(db, "hr-data", userId, "leaves", leaveId), { status: 'rejected' }); showAlert('نجاح', 'تم رفض طلب الإجازة.'); } catch (e) { showAlert('خطأ', 'فشلت عملية الرفض.'); }
        };
        window.deleteLeave = (leaveId) => {
            showConfirmation('تأكيد الحذف', 'هل أنت متأكد من حذف طلب الإجازة هذا؟', async () => {
                try { await deleteDoc(doc(db, "hr-data", userId, "leaves", leaveId)); showAlert('نجاح', 'تم حذف طلب الإجازة.'); } catch (e) { showAlert('خطأ', 'فشلت عملية الحذف.'); }
            });
        };

        // --- Payroll Functions ---
        const handlePayrollGeneration = async (event) => {
            event.preventDefault();
            const month = document.getElementById('payroll-month').value;
            const year = document.getElementById('payroll-year').value;
            const payrollId = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
            if (state.payrolls.some(p => p.id === payrollId)) return showAlert('موجود مسبقاً', 'تم إصدار مسير رواتب لهذا الشهر بالفعل.');

            const payrollYear = parseInt(year), payrollMonth = parseInt(month);
            const eligibleEmployees = state.employees.filter(e => (e.status === 'active' || e.status === 'on_leave') && e.startDate && (new Date(e.startDate).getFullYear() < payrollYear || (new Date(e.startDate).getFullYear() === payrollYear && new Date(e.startDate).getMonth() <= payrollMonth)));
            if (eligibleEmployees.length === 0) return showAlert('لا يوجد موظفين', 'لا يوجد موظفين مؤهلين لإصدار مسير رواتب لهم.');

            const batch = writeBatch(db);
            let totals = { base: 0, allow: 0, deduct: 0, absence: 0, late: 0, overtime: 0, net: 0 };
            
            for (const emp of eligibleEmployees) { 
                const allowances = (await getDocs(collection(db, "hr-data", userId, "employees", emp.id, "allowances"))).docs.map(d => d.data());
                let fixedDeductions = (await getDocs(collection(db, "hr-data", userId, "employees", emp.id, "deductions"))).docs.map(d => d.data());
                if (emp.nationality?.toLowerCase().includes('سعودي') && !fixedDeductions.some(d => d.name.includes('التأمينات'))) {
                    fixedDeductions.push({ name: 'خصم التأمينات الاجتماعية (GOSI)', amount: (emp.salary + (allowances.find(a => a.name.includes('سكن'))?.amount || 0)) * 0.10, includedInPayroll: true, isAuto: true });
                }
                const empTotalAllowances = allowances.filter(a => a.includedInPayroll).reduce((s, i) => s + i.amount, 0);
                const empTotalFixedDeductions = fixedDeductions.filter(d => d.includedInPayroll).reduce((s, i) => s + i.amount, 0);
                const grossSalary = emp.salary + empTotalAllowances;
                const workDaysInMonth = calculateWorkDaysInMonth(payrollYear, payrollMonth, emp.weekendDays);
                const dailyRate = workDaysInMonth > 0 ? (grossSalary / workDaysInMonth) : 0;
                const hourlyRate = dailyRate / 8;
                let absenceDeduction = 0, lateDeduction = 0, overtimePay = 0;

                const payrollMonthStartDate = new Date(payrollYear, payrollMonth, 1), payrollMonthEndDate = new Date(payrollYear, payrollMonth + 1, 0);
                const paidLeaveTypes = state.leaveTypes.filter(lt => lt.paymentType === 'paid' || lt.paymentType === 'paid_in_advance').map(lt => lt.id);
                let paidLeaveWorkDaysInMonth = state.leaves.filter(l => l.employeeId === emp.id && l.status === 'approved' && paidLeaveTypes.includes(l.leaveType) && new Date(l.startDate) <= payrollMonthEndDate && new Date(l.endDate) >= payrollMonthStartDate)
                    .reduce((sum, leave) => sum + calculateWorkingDays(new Date(Math.max(new Date(leave.startDate), payrollMonthStartDate)), new Date(Math.min(new Date(leave.endDate), payrollMonthEndDate)), emp.weekendDays), 0);
                
                const attendanceSnap = await getDoc(doc(db, "hr-data", userId, "employees", emp.id, "attendance", payrollId));
                if (attendanceSnap.exists()) {
                    const data = attendanceSnap.data();
                    absenceDeduction = dailyRate * Math.max(0, workDaysInMonth - (data.attendedDays || 0) - paidLeaveWorkDaysInMonth);
                    if (emp.tardinessRule?.enabled && emp.tardinessRule.deductionHours > 0) {
                        lateDeduction = (data.lateIncidentsOverGrace || 0) * emp.tardinessRule.deductionHours * hourlyRate;
                    } else {
                        lateDeduction = (hourlyRate / 60) * ((data.lateHours * 60) + data.lateMinutes);
                    }
                    overtimePay = (hourlyRate * 1.5 / 60) * ((data.overtimeHours * 60) + data.overtimeMinutes);
                } else {
                    absenceDeduction = dailyRate * Math.max(0, workDaysInMonth - paidLeaveWorkDaysInMonth);
                }
                
                const empNet = (grossSalary + overtimePay) - (empTotalFixedDeductions + absenceDeduction + lateDeduction);
                batch.set(doc(db, "hr-data", userId, "payrolls", payrollId, "records", emp.id), { ...emp, allowances, deductions: fixedDeductions, grossSalary, absenceDeduction, lateDeduction, overtimePay, netPay: empNet });
                totals.base += emp.salary; totals.allow += empTotalAllowances; totals.deduct += empTotalFixedDeductions; totals.absence += absenceDeduction; totals.late += lateDeduction; totals.overtime += overtimePay; totals.net += empNet;
            }

            batch.set(doc(db, "hr-data", userId, "payrolls", payrollId), { createdAt: new Date(), month: payrollMonth, year: payrollYear, totalBaseSalary: totals.base, totalAllowances: totals.allow, totalDeductions: totals.deduct, totalAbsenceDeduction: totals.absence, totalLateDeduction: totals.late, totalOvertimePay: totals.overtime, netPay: totals.net, employeeCount: eligibleEmployees.length, isApproved: false });

            try { await batch.commit(); showAlert('نجاح', `تم إصدار مسير رواتب شهر ${payrollMonth + 1} / ${year} بنجاح.`); closeModal('generatePayrollModal'); } catch (e) { showAlert('خطأ', 'فشل إصدار مسير الرواتب.'); }
        };

        const renderPayrollHistory = () => {
            if (!ui.payrollHistoryContainer) return;
            if (state.payrolls.length === 0) {
                ui.payrollHistoryContainer.innerHTML = `<p class="text-sm text-slate-500 text-center">لم يتم إصدار أي مسيرات رواتب.</p>`;
                return;
            }
            const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            ui.payrollHistoryContainer.innerHTML = state.payrolls.sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis()).map(p => `<div onclick="displayPayrollDetails('${p.id}')" class="p-3 rounded-lg cursor-pointer hover:bg-slate-100 border"><div class="flex justify-between items-center"><p class="font-semibold">مسير رواتب ${months[p.month]} ${p.year}</p><span class="text-xs font-bold ${p.isApproved ? 'text-green-700 bg-green-100' : 'text-amber-700 bg-amber-100'} px-2 py-1 rounded-full">${p.isApproved ? 'معتمد' : 'غير معتمد'}</span></div><p class="text-sm text-slate-600">صافي المبلغ: ${formatNumber(p.netPay)} ر.س</p></div>`).join('');
        };

        window.displayPayrollDetails = async (payrollId) => {
            const payroll = state.payrolls.find(p => p.id === payrollId);
            if (!payroll) return;
            const records = (await getDocs(collection(db, "hr-data", userId, "payrolls", payrollId, "records"))).docs.map(d => d.data());
            const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            const actionButtons = payroll.isApproved ? `<div class="flex justify-between items-center"><p class="text-sm text-green-600 font-semibold bg-green-100 p-2 rounded-md text-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>هذا المسير معتمد</p></div>` : `<button onclick="approvePayroll('${payroll.id}')" class="text-sm bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">اعتماد المسير</button><button onclick="deletePayroll('${payroll.id}')" class="text-sm bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md ml-2">حذف المسير</button>`;
            let tableHTML = records.map(r => `<tr class="border-b"><td class="p-2">${r.name}</td><td class="p-2">${formatNumber(r.salary)}</td><td class="p-2">${formatNumber(r.allowances.filter(a => a.includedInPayroll).reduce((s, i) => s + i.amount, 0))}</td><td class="p-2 text-red-600">-${formatNumber(r.absenceDeduction || 0)}</td><td class="p-2 text-red-600">-${formatNumber(r.lateDeduction || 0)}</td><td class="p-2 text-green-600">+${formatNumber(r.overtimePay || 0)}</td><td class="p-2 text-red-600">-${formatNumber(r.deductions.filter(d=>d.includedInPayroll).reduce((s, i) => s + i.amount, 0))}</td><td class="p-2 font-bold">${formatNumber(r.netPay)}</td><td class="p-2 text-center"><button onclick="printEmployeePayslip('${payrollId}', '${r.id}')" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">طباعة</button></td></tr>`).join('');
            ui.payrollDetailsContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">تفاصيل مسير رواتب ${months[payroll.month]} ${payroll.year}</h3><div><button onclick="printAllPayslips('${payrollId}')" class="text-sm bg-violet-100 text-violet-800 px-3 py-1 rounded-md hover:bg-violet-200 ml-2">طباعة كل القسائم</button><button onclick="printPayrollSummary('${payrollId}')" class="text-sm bg-slate-200 px-3 py-1 rounded-md hover:bg-slate-300">طباعة الملخص</button></div></div><div class="mb-4">${actionButtons}</div><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-slate-50"><tr><th class="p-2 text-right font-semibold">الموظف</th><th class="p-2 text-right font-semibold">الراتب الأساسي</th><th class="p-2 text-right font-semibold">البدلات</th><th class="p-2 text-right font-semibold">خصم الغياب</th><th class="p-2 text-right font-semibold">خصم التأخير</th><th class="p-2 text-right font-semibold">إضافي</th><th class="p-2 text-right font-semibold">خصومات أخرى</th><th class="p-2 text-right font-semibold">صافي المستحق</th><th class="p-2 text-center font-semibold">قسيمة</th></tr></thead><tbody>${tableHTML}</tbody><tfoot class="font-bold bg-slate-100"><tr><td class="p-2">الإجمالي (ر.س)</td><td class="p-2">${formatNumber(payroll.totalBaseSalary)}</td><td class="p-2">${formatNumber(payroll.totalAllowances)}</td><td class="p-2 text-red-600">-${formatNumber(payroll.totalAbsenceDeduction || 0)}</td><td class="p-2 text-red-600">-${formatNumber(payroll.totalLateDeduction || 0)}</td><td class="p-2 text-green-600">+${formatNumber(payroll.totalOvertimePay || 0)}</td><td class="p-2 text-red-600">-${formatNumber(payroll.totalDeductions)}</td><td class="p-2">${formatNumber(payroll.netPay)}</td><td></td></tr></tfoot></table></div></div>`;
            ui.payrollDetailsContainer.classList.remove('hidden');
        };

        window.approvePayroll = (payrollId) => {
            showConfirmation('تأكيد الاعتماد', 'هل أنت متأكد من اعتماد هذا المسير؟ لا يمكن التراجع عن هذا الإجراء.', async () => {
                try { await updateDoc(doc(db, "hr-data", userId, "payrolls", payrollId), { isApproved: true }); showAlert('نجاح', 'تم اعتماد مسير الرواتب.'); displayPayrollDetails(payrollId); } catch (e) { showAlert('خطأ', 'فشلت عملية الاعتماد.'); }
            });
        };

        window.deletePayroll = (payrollId) => {
            showConfirmation('تأكيد الحذف', 'هل أنت متأكد من حذف هذا المسير؟ سيتم حذف جميع سجلات الموظفين فيه.', async () => {
                try { await deleteDoc(doc(db, "hr-data", userId, "payrolls", payrollId)); ui.payrollDetailsContainer.classList.add('hidden'); showAlert('نجاح', 'تم حذف مسير الرواتب.'); } catch (e) { showAlert('خطأ', 'فشلت عملية الحذف.'); }
            });
        };

        // --- Printing Functions ---
        function generateCorporatePayslipHTML(record, payroll) {
            const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            const earnings = [{ name: 'الراتب الأساسي', amount: record.salary }, ...record.allowances.filter(a => a.includedInPayroll).map(a => ({ name: a.name, amount: a.amount }))];
            if (record.overtimePay > 0) earnings.push({ name: 'أجر العمل الإضافي', amount: record.overtimePay });
            const deductions = [...record.deductions.filter(d => d.includedInPayroll).map(d => ({ name: d.name, amount: d.amount }))];
            if (record.absenceDeduction > 0) deductions.push({ name: 'خصم الغياب', amount: record.absenceDeduction });
            if (record.lateDeduction > 0) deductions.push({ name: 'خصم التأخير', amount: record.lateDeduction });
            const totalEarnings = earnings.reduce((s, i) => s + i.amount, 0), totalDeductions = deductions.reduce((s, i) => s + i.amount, 0);
            return `<div class="payslip-page bg-white text-gray-900" style="width:100%;height:100%;margin:auto;display:flex;flex-direction:column;border:1px solid #e5e7eb;padding:0.8cm;font-size:9pt;"><header class="flex justify-center items-center pb-2 border-b border-gray-300"><div class="text-center"><h1 class="text-2xl font-bold">${state.settings.name||'اسم الشركة'}</h1><p class="text-sm">قسيمة الراتب الشهرية</p><p class="text-sm">الفترة: ${months[payroll.month]} ${payroll.year}</p></div></header><section class="grid grid-cols-4 gap-x-4 py-3 border-b border-gray-200 text-xs"><div><strong class="text-gray-600 block">اسم الموظف:</strong> ${record.name||''}</div><div><strong class="text-gray-600 block">الرقم الوظيفي:</strong> ${record.employeeId||''}</div><div><strong class="text-gray-600 block">المنصب:</strong> ${record.position||''}</div><div><strong class="text-gray-600 block">القسم:</strong> ${record.department||''}</div><div><strong class="text-gray-600 block">تاريخ الالتحاق:</strong> ${record.startDate||''}</div><div><strong class="text-gray-600 block">تاريخ الدفع:</strong> ${formatGregorianDate(new Date(payroll.year,payroll.month+1,0))}</div></section><section class="flex-grow grid grid-cols-2 gap-x-6 py-3"><div class="bg-gray-50 p-2 rounded"><h3 class="font-bold text-center text-base mb-2 pb-1 border-b">الاستحقاقات</h3><table class="w-full text-xs">${earnings.map(e=>`<tr><td class="py-1 pr-1">${e.name}</td><td class="py-1 pl-1 text-left font-mono">${formatNumber(e.amount)}</td></tr>`).join('')}</table></div><div class="bg-gray-50 p-2 rounded"><h3 class="font-bold text-center text-base mb-2 pb-1 border-b">الاستقطاعات</h3><table class="w-full text-xs">${deductions.map(d=>`<tr><td class="py-1 pr-1">${d.name}</td><td class="py-1 pl-1 text-left font-mono">${formatNumber(d.amount)}</td></tr>`).join('')}</table></div></section><section class="grid grid-cols-2 gap-x-6 py-2 bg-gray-100 rounded"><div class="space-y-1 text-sm"><div class="flex justify-between"><strong>إجمالي الاستحقاقات:</strong><span class="font-mono">${formatNumber(totalEarnings)} ر.س</span></div><div class="flex justify-between"><strong>إجمالي الاستقطاعات:</strong><span class="font-mono">${formatNumber(totalDeductions)} ر.س</span></div><div class="flex justify-between font-bold text-base border-t pt-1 mt-1"><strong>صافي الراتب المستحق:</strong><span class="font-mono">${formatNumber(record.netPay)} ر.س</span></div></div><div class="text-sm text-center self-center"><strong>طريقة الدفع:</strong> تحويل بنكي</div></section><footer class="mt-auto pt-4 text-xs"><div class="grid grid-cols-2 gap-8 text-center"><div><p class="h-10"></p><p class="border-t border-gray-400 pt-1 font-semibold">توقيع الموارد البشرية</p></div><div><p class="h-10"></p><p class="border-t border-gray-400 pt-1 font-semibold">توقيع الموظف</p></div></div><p class="text-center text-gray-500 mt-2">هذا المستند تم إنشاؤه بواسطة الحاسب الآلي.</p></footer></div>`;
        }

        window.printAllPayslips = async (payrollId) => {
            const payroll = state.payrolls.find(p => p.id === payrollId);
            if (!payroll) return;
            const records = (await getDocs(collection(db, "hr-data", userId, "payrolls", payrollId, "records"))).docs.map(d => d.data());
            if (records.length === 0) return showAlert('لا توجد بيانات', 'لا يوجد موظفين في هذا المسير.');
            const printableDiv = document.getElementById('printable-payroll');
            printableDiv.innerHTML = records.map(record => generateCorporatePayslipHTML(record, payroll)).join('');
            window.print();
            printableDiv.innerHTML = '';
        };

        window.printPayrollSummary = async (payrollId) => {
            const payroll = state.payrolls.find(p => p.id === payrollId);
            if (!payroll) return;
            const records = (await getDocs(collection(db, "hr-data", userId, "payrolls", payrollId, "records"))).docs.map(d => d.data());
            const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            const allAllowances = [...new Set(records.flatMap(r => r.allowances?.filter(a => a.includedInPayroll).map(a => a.name) || []))];
            const allDeductions = [...new Set(records.flatMap(r => r.deductions?.filter(d => d.includedInPayroll).map(d => d.name) || []))];
            const headerHTML = `<tr><th class="p-2 border">الموظف</th><th class="p-2 border">الراتب الأساسي</th>${allAllowances.map(n=>`<th class="p-2 border">${n}</th>`).join('')}<th class="p-2 border bg-yellow-100">إجمالي الاستحقاقات</th>${allDeductions.map(n=>`<th class="p-2 border">${n}</th>`).join('')}<th class="p-2 border">خصم الغياب</th><th class="p-2 border">خصم التأخير</th><th class="p-2 border bg-red-100">إجمالي الخصومات</th><th class="p-2 border">إضافي</th><th class="p-2 border bg-green-100">صافي المستحق</th></tr>`;
            const bodyHTML = records.map(r => {
                const empAllows = new Map(r.allowances?.filter(a=>a.includedInPayroll).map(a=>[a.name,a.amount])||[]);
                const empDeducts = new Map(r.deductions?.filter(d=>d.includedInPayroll).map(d=>[d.name,d.amount])||[]);
                const gross = r.salary + Array.from(empAllows.values()).reduce((s,v)=>s+v,0);
                const totalDeducts = Array.from(empDeducts.values()).reduce((s,v)=>s+v,0) + (r.absenceDeduction||0) + (r.lateDeduction||0);
                return `<tr class="border-b"><td class="p-2 border">${r.name}</td><td class="p-2 border">${formatNumber(r.salary)}</td>${allAllowances.map(n=>`<td class="p-2 border">${formatNumber(empAllows.get(n)||0)}</td>`).join('')}<td class="p-2 border font-bold bg-yellow-100">${formatNumber(gross)}</td>${allDeductions.map(n=>`<td class="p-2 border text-red-600">${formatNumber(empDeducts.get(n)||0)}</td>`).join('')}<td class="p-2 border text-red-600">${formatNumber(r.absenceDeduction||0)}</td><td class="p-2 border text-red-600">${formatNumber(r.lateDeduction||0)}</td><td class="p-2 border font-bold bg-red-100">${formatNumber(totalDeducts)}</td><td class="p-2 border text-green-600">${formatNumber(r.overtimePay||0)}</td><td class="p-2 border font-bold bg-green-100">${formatNumber(r.netPay)}</td></tr>`;
            }).join('');
            const allowanceTotals = allAllowances.map(n => records.reduce((s,r)=>s+(r.allowances?.find(a=>a.name===n&&a.includedInPayroll)?.amount||0),0));
            const deductionTotals = allDeductions.map(n => records.reduce((s,r)=>s+(r.deductions?.find(d=>d.name===n&&d.includedInPayroll)?.amount||0),0));
            const footerHTML = `<tr class="font-bold bg-slate-200"><td class="p-2 border">الإجمالي</td><td class="p-2 border">${formatNumber(payroll.totalBaseSalary)}</td>${allowanceTotals.map(t=>`<td class="p-2 border">${formatNumber(t)}</td>`).join('')}<td class="p-2 border bg-yellow-200">${formatNumber(payroll.totalBaseSalary+allowanceTotals.reduce((s,t)=>s+t,0))}</td>${deductionTotals.map(t=>`<td class="p-2 border text-red-600">${formatNumber(t)}</td>`).join('')}<td class="p-2 border text-red-600">${formatNumber(payroll.totalAbsenceDeduction)}</td><td class="p-2 border text-red-600">${formatNumber(payroll.totalLateDeduction)}</td><td class="p-2 border bg-red-200">${formatNumber(payroll.totalDeductions+payroll.totalAbsenceDeduction+payroll.totalLateDeduction)}</td><td class="p-2 border text-green-600">${formatNumber(payroll.totalOvertimePay)}</td><td class="p-2 border bg-green-200">${formatNumber(payroll.netPay)}</td></tr>`;
            document.getElementById('printable-payroll').innerHTML = `<div class="p-4"><header class="text-center mb-6"><h1 class="text-2xl font-bold">${state.settings.name||'ملخص الرواتب'}</h1><h2 class="text-xl font-semibold">مسير رواتب شهر ${months[payroll.month]} ${payroll.year}</h2><p class="text-sm text-gray-500">تاريخ الطباعة: ${formatGregorianDate(new Date())}</p></header><div class="overflow-x-auto"><table class="w-full text-xs border-collapse border"><thead>${headerHTML}</thead><tbody>${bodyHTML}</tbody><tfoot>${footerHTML}</tfoot></table></div></div>`;
            window.print();
            document.getElementById('printable-payroll').innerHTML = '';
        };
        
        window.printEmployeePayslip = async (payrollId, recordId) => {
            const recordDoc = await getDoc(doc(db, "hr-data", userId, "payrolls", payrollId, "records", recordId));
            if (!recordDoc.exists()) return showAlert('خطأ', 'لم يتم العثور على سجل الموظف.');
            const printableDiv = document.getElementById('printable-payroll');
            printableDiv.innerHTML = generateCorporatePayslipHTML(recordDoc.data(), state.payrolls.find(p => p.id === payrollId));
            window.print();
            printableDiv.innerHTML = '';
        };

        // --- Attendance Functions ---
        window.downloadAttendanceTemplate = () => {
            const csvContent = `Date,CheckIn,CheckOut,Notes\nYYYY-MM-DD,HH:MM,HH:MM,Your notes here\n2024-07-01,09:00,17:00,Normal Day`;
            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "attendance_template.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const handleProcessAttendanceFile = () => {
            const employee = state.employees.find(e => e.id === document.getElementById('upload-attendance-employee-id').value);
            if (!employee || !document.getElementById('attendance-file-input').files[0]) return;
            Papa.parse(document.getElementById('attendance-file-input').files[0], {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length) return showAlert('خطأ في الملف', 'حدث خطأ أثناء قراءة الملف.');
                    let attendedDays = 0, totalLateMinutes = 0, totalOvertimeMinutes = 0, lateIncidentsOverGrace = 0;
                    const [startHour, startMinute] = (state.settings.startTime || '09:00').split(':').map(Number);
                    results.data.forEach(row => {
                        if (row.CheckIn && row.CheckOut) {
                            attendedDays++;
                            const dailyLateMinutes = (new Date(`1970-01-01T${row.CheckIn}:00`).getHours() - startHour) * 60 + (new Date(`1970-01-01T${row.CheckIn}:00`).getMinutes() - startMinute);
                            if (dailyLateMinutes > 0) {
                                totalLateMinutes += dailyLateMinutes;
                                if (employee.tardinessRule?.enabled && dailyLateMinutes > (employee.tardinessRule.gracePeriodMinutes || 0)) lateIncidentsOverGrace++;
                            }
                            const durationHours = (new Date(`1970-01-01T${row.CheckOut}:00`) - new Date(`1970-01-01T${row.CheckIn}:00`)) / 3600000;
                            if (durationHours > 8) totalOvertimeMinutes += (durationHours - 8) * 60;
                        }
                    });
                    const summaryDiv = document.getElementById('attendance-upload-summary');
                    summaryDiv.innerHTML = `<h4 class="font-bold mb-2">البيانات المستخرجة:</h4><p><strong>أيام الحضور:</strong> ${attendedDays}</p><p><strong>التأخير:</strong> ${Math.floor(totalLateMinutes/60)} س و ${totalLateMinutes%60} د</p><p><strong>الإضافي:</strong> ${Math.floor(totalOvertimeMinutes/60)} س و ${Math.round(totalOvertimeMinutes%60)} د</p><p class="font-bold text-red-600"><strong>مخالفات التأخير:</strong> ${lateIncidentsOverGrace}</p>`;
                    summaryDiv.classList.remove('hidden');
                    document.getElementById('upload-attended-days').value = attendedDays;
                    document.getElementById('upload-late-incidents').value = lateIncidentsOverGrace;
                    document.getElementById('upload-late-hours').value = Math.floor(totalLateMinutes/60);
                    document.getElementById('upload-late-minutes').value = totalLateMinutes%60;
                    document.getElementById('upload-overtime-hours').value = Math.floor(totalOvertimeMinutes/60);
                    document.getElementById('upload-overtime-minutes').value = Math.round(totalOvertimeMinutes%60);
                    document.getElementById('attendance-upload-edit-fields').classList.remove('hidden');
                    document.getElementById('process-attendance-file-btn').classList.add('hidden');
                    document.getElementById('save-processed-attendance-btn').classList.remove('hidden');
                }
            });
        };

        const handleAttendanceUploadFormSubmit = async (event) => {
            event.preventDefault();
            const year = document.getElementById('upload-attendance-year').value;
            const month = document.getElementById('upload-attendance-month').value;
            const attendanceData = {
                attendedDays: Number(document.getElementById('upload-attended-days').value),
                lateIncidentsOverGrace: Number(document.getElementById('upload-late-incidents').value),
                lateHours: Number(document.getElementById('upload-late-hours').value),
                lateMinutes: Number(document.getElementById('upload-late-minutes').value),
                overtimeHours: Number(document.getElementById('upload-overtime-hours').value),
                overtimeMinutes: Number(document.getElementById('upload-overtime-minutes').value),
                totalDaysInMonth: getDaysInMonth(parseInt(year), parseInt(month)),
            };
            try {
                await setDoc(doc(db, "hr-data", userId, "employees", document.getElementById('upload-attendance-employee-id').value, "attendance", `${year}-${String(parseInt(month)+1).padStart(2,'0')}`), attendanceData);
                showAlert('نجاح', 'تم حفظ بيانات الحضور.');
                closeModal('attendanceUploadModal');
            } catch (e) { showAlert('خطأ', 'فشل حفظ بيانات الحضور.'); }
        };

        const handleAttendanceFormSubmit = async (event) => {
            event.preventDefault();
            const form = event.target;
            const year = form['attendance-year'].value, month = form['attendance-month'].value;
            const attendanceData = {
                totalDaysInMonth: getDaysInMonth(parseInt(year), parseInt(month)),
                attendedDays: Number(form['attended-days'].value),
                lateHours: Number(form['late-hours'].value) || 0,
                lateMinutes: Number(form['late-minutes'].value) || 0,
                overtimeHours: Number(form['overtime-hours'].value) || 0,
                overtimeMinutes: Number(form['overtime-minutes'].value) || 0,
                lateIncidentsOverGrace: Number(form['late-incidents-over-grace'].value) || 0,
            };
            if (isNaN(attendanceData.attendedDays)) return showAlert('بيانات ناقصة', 'يرجى إدخال أيام الحضور الفعلية.');
            try {
                await setDoc(doc(db, "hr-data", userId, "employees", form['attendance-employee-id'].value, "attendance", `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`), attendanceData);
                showAlert('نجاح', 'تم حفظ بيانات الحضور.');
                closeModal('attendanceModal');
            } catch (e) { showAlert('خطأ', 'فشل حفظ بيانات الحضور.'); }
        };

        function renderAttendancePage() {
            if (!ui.attendanceTableBody) return;
            if (state.employees.length === 0) {
                ui.attendanceTableBody.innerHTML = '<tr class="border-b"><td colspan="3" class="text-center p-4">لا يوجد موظفين لعرضهم.</td></tr>';
                return;
            }
            ui.attendanceTableBody.innerHTML = state.employees.sort((a,b)=>a.name.localeCompare(b.name)).map(emp => `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-6 py-4 font-medium text-slate-900">${emp.name}</td><td class="px-6 py-4">${emp.position}</td><td class="px-6 py-4 text-center"><button onclick="openModal('attendanceUploadModal', '${emp.id}')" class="bg-blue-100 text-blue-800 font-semibold px-4 py-1 rounded-full hover:bg-blue-200">رفع ملف</button><button onclick="openModal('attendanceModal', '${emp.id}')" class="bg-violet-100 text-violet-800 font-semibold px-4 py-1 rounded-full hover:bg-violet-200 ml-2">تسجيل يدوي</button></td></tr>`).join("");
        }
        
        function updateMonthDaysDisplay() {
            const month = parseInt(document.getElementById('attendance-month').value);
            const year = parseInt(document.getElementById('attendance-year').value);
            if (!isNaN(month) && !isNaN(year)) document.getElementById('month-days-display').textContent = getDaysInMonth(year, month);
        }

        // --- Settings Functions ---
        const handleSettingsSubmit = async (event) => {
            event.preventDefault();
            const settingsData = {
                name: ui.companyNameInput.value.trim(),
                address: ui.companyAddressInput.value.trim(),
                crNumber: ui.companyCRInput.value.trim(),
                startTime: ui.companyStartTimeInput.value,
            };
            try {
                await setDoc(doc(db, "hr-data", userId, "settings", "companyProfile"), settingsData, { merge: true });
                showAlert('نجاح', 'تم حفظ الإعدادات بنجاح.');
            } catch (e) { showAlert('خطأ', `فشل حفظ الإعدادات: ${e.message}`); }
        };

        const handleLeaveTypeFormSubmit = async (event) => {
            event.preventDefault();
            const form = event.target;
            const leaveData = {
                name: form['leave-type-name'].value.trim(),
                days: Number(form['leave-type-days'].value),
                paymentType: form['leave-type-payment'].value,
                recurring: form['leave-type-recurring'].value,
            };
            if (!leaveData.name || isNaN(leaveData.days)) return showAlert('بيانات ناقصة', 'يرجى إدخال اسم الإجازة وعدد الأيام بشكل صحيح.');
            const editId = form['leave-type-edit-id'].value;
            try {
                if (editId) {
                    await updateDoc(doc(db, "hr-data", userId, "leave-types", editId), leaveData);
                    showAlert('نجاح', 'تم تعديل نوع الإجازة.');
                } else {
                    leaveData.isStandard = false;
                    await addDoc(collection(db, "hr-data", userId, "leave-types"), leaveData);
                    showAlert('نجاح', 'تمت إضافة نوع الإجازة.');
                }
                form.reset();
                form['leave-type-edit-id'].value = '';
                form.querySelector('button[type="submit"]').textContent = 'إضافة نوع';
            } catch (e) { showAlert('خطأ', 'فشل حفظ نوع الإجازة.'); }
        };

        function renderLeaveTypesSettings() {
            if (!ui.leaveTypesTableBody) return;
            const paymentText = { paid: 'مدفوعة', unpaid: 'بدون أجر', paid_in_advance: 'مدفوعة مقدماً' };
            const recurringText = { annually: 'سنوي', once: 'مرة واحدة', 'multiple_per_year': 'متعددة سنوياً', none: 'غير متكرر' };
            ui.leaveTypesTableBody.innerHTML = state.leaveTypes.map(lt => `<tr class="border-b"><td class="px-6 py-4">${lt.name}</td><td class="px-6 py-4">${lt.days}</td><td class="px-6 py-4">${paymentText[lt.paymentType]||lt.paymentType}</td><td class="px-6 py-4">${recurringText[lt.recurring]||lt.recurring}</td><td class="px-6 py-4"><button onclick="editLeaveType('${lt.id}')" class="text-blue-600 hover:text-blue-800 font-semibold px-2">تعديل</button><button onclick="deleteLeaveType('${lt.id}')" class="text-red-500 hover:text-red-700 font-semibold px-2">حذف</button></td></tr>`).join('');
        }
        
        window.editLeaveType = (id) => {
            const leaveType = state.leaveTypes.find(lt => lt.id === id);
            if (!leaveType) return;
            const form = ui.leaveTypeForm;
            form['leave-type-edit-id'].value = id;
            form['leave-type-name'].value = leaveType.name;
            form['leave-type-days'].value = leaveType.days;
            form['leave-type-payment'].value = leaveType.paymentType;
            form['leave-type-recurring'].value = leaveType.recurring;
            form.querySelector('button[type="submit"]').textContent = 'حفظ التعديلات';
            form['leave-type-name'].focus();
        };

        window.deleteLeaveType = (id) => {
            showConfirmation('تأكيد الحذف', 'هل أنت متأكد من حذف نوع الإجازة هذا؟', async () => {
                try { await deleteDoc(doc(db, "hr-data", userId, "leave-types", id)); showAlert('نجاح', 'تم حذف نوع الإجازة.'); } catch (e) { showAlert('خطأ', 'فشلت عملية الحذف.'); }
            });
        };

        function populateLeaveTypeDropdown() {
            const select = document.getElementById('leave-type');
            if (!select) return;
            select.innerHTML = state.leaveTypes.sort((a,b) => a.name.localeCompare(b.name)).map(lt => `<option value="${lt.id}">${lt.name}</option>`).join('');
        }


        // --- Initial Module Load ---
        function initializeHrModule() {
            if (window.app && window.auth && window.db) {
                app = window.app;
                auth = window.auth;
                db = window.db;

                if (auth.currentUser) {
                    userId = auth.currentUser.uid;
                    setupRealtimeListeners();
                } else {
                    console.error("HR Module Error: No authenticated user found.");
                    window.showMainMenu();
                }
            } else {
                console.error("HR Module Error: Firebase not initialized by the main portal.");
                alert("خطأ في تحميل النظام. يرجى المحاولة مرة أخرى من البوابة الرئيسية.");
            }
        }
        
        function setupEventListeners() {
            if (ui.addEmployeeForm) ui.addEmployeeForm.addEventListener('submit', handleEmployeeFormSubmit);
            if (ui.generatePayrollForm) ui.generatePayrollForm.addEventListener('submit', handlePayrollGeneration);
            if (ui.attendanceForm) ui.attendanceForm.addEventListener('submit', handleAttendanceFormSubmit);
            if (ui.settingsForm) ui.settingsForm.addEventListener('submit', handleSettingsSubmit);
            if (ui.leaveRequestForm) ui.leaveRequestForm.addEventListener('submit', handleLeaveRequestSubmit);
            if (ui.leaveTypeForm) ui.leaveTypeForm.addEventListener('submit', handleLeaveTypeFormSubmit);
            
            const processFileBtn = document.getElementById('process-attendance-file-btn');
            if(processFileBtn) processFileBtn.addEventListener('click', handleProcessAttendanceFile);
            if(ui.attendanceUploadForm) ui.attendanceUploadForm.addEventListener('submit', handleAttendanceUploadFormSubmit);

            const attMonth = document.getElementById('attendance-month');
            const attYear = document.getElementById('attendance-year');
            const leaveEmpId = document.getElementById('leave-employee-id');
            const leaveType = document.getElementById('leave-type');
            const searchInput = document.getElementById('employee-search-input');

            if(attMonth) attMonth.addEventListener('change', updateMonthDaysDisplay);
            if(attYear) attYear.addEventListener('change', updateMonthDaysDisplay);
            if(leaveEmpId) leaveEmpId.addEventListener('change', updateLeaveBalanceDisplay);
            if(leaveType) leaveType.addEventListener('change', updateLeaveBalanceDisplay);
            if(searchInput) searchInput.addEventListener('input', renderEmployeesPage);
        }

        initializeHrModule();
        setupEventListeners();

    </script>
</body>
</html>
